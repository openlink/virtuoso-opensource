<?xml version="1.0" encoding="UTF-8"?>
<!--
 -
 -  $Id$
 -
 -  This file is part of the OpenLink Software Virtuoso Open-Source (VOS)
 -  project.
 -
 -  Copyright (C) 1998-2007 OpenLink Software
 -
 -  This project is free software; you can redistribute it and/or modify it
 -  under the terms of the GNU General Public License as published by the
 -  Free Software Foundation; only version 2 of the License, dated June 1991.
 -
 -  This program is distributed in the hope that it will be useful, but
 -  WITHOUT ANY WARRANTY; without even the implied warranty of
 -  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 -  General Public License for more details.
 -
 -  You should have received a copy of the GNU General Public License along
 -  with this program; if not, write to the Free Software Foundation, Inc.,
 -  51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
 -
-->
<v:page name="ab" decor="template/template.vspx" style="template/template.xsl" fast-render="1" button-anchors="1" xmlns:v="http://www.openlinksw.com/vspx/" xmlns:vm="http://www.openlinksw.com/vspx/macro" doctype="-//W3C//DTD XHTML 1.0 Transitional//EN" doctype-system="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

  <v:method name="mode_test" arglist="">
    <![CDATA[
      declare pos integer;
      declare params, names any;

      params := self.vc_page.vc_event.ve_params;
      self.abContact := get_keyword ('id', params, '');
      if (self.abContact <> '')
      {
        self.v_id := cast (self.abContact as integer);
        if (self.v_id = -1)
        {
          if (self.account_role not in ('public', 'guest'))
          {
            self.abAction := 'create';
            self.v_name := trim (get_keyword ('name', params, ''));
            self.v_mail := trim (get_keyword ('mail', params, ''));
            if ((self.v_name = '') and (self.v_mail <> ''))
            {
              pos := strchr (self.v_mail, '@');
              if (pos is not null)
                self.v_name := left (self.v_mail, pos);
            }
            self.v_fullName := self.v_name;
            names := split_and_decode (self.v_fullName, 0, '\0\0 ');
            if (length (names) >= 1)
              self.v_fName := names [0];
            if (length (names) > 1)
              self.v_lName := names [length (names) - 1];
          }
        } else {
          self.abAction := 'view';
      }
      }
    ]]>
  </v:method>

  <v:method name="toolbarLabel" arglist="in cmd varchar">
    <![CDATA[
      if (self.abLabels = 0)
        return '';
      return sprintf ('<br /><span class="toolbarLabel">%s</span>', cmd);
    ]]>
  </v:method>

  <v:method name="toolbarEnable" arglist="in cmd varchar">
    <![CDATA[
      if ((cmd = 'create') and ((self.account_role in ('public', 'guest')) or (self.abScope = 'MySharedContacts')))
        return 0;
      if ((cmd = 'import') and ((self.account_role in ('public', 'guest')) or (self.abScope = 'MySharedContacts')))
        return 0;
      if ((cmd = 'export') and ((self.account_role in ('public', 'guest')) or (self.abScope = 'MySharedContacts')))
        return 0;
      return 1;
    ]]>
  </v:method>

  <v:method name="toolbarShow" arglist="in cmd varchar, in cmdLabel varchar, in cmdOnClick varchar, in cmdImageSrc varchar, in cmdImageGraySrc varchar">
    <![CDATA[
      declare imageSrc, onclickEvent, styleStr varchar;

      if (self.toolbarEnable(cmd))
      {
        onclickEvent := cmdOnClick;
        imageSrc := cmdImageSrc;
        styleStr := 'style="cursor: pointer;"';
      } else {
        onclickEvent := '';
        imageSrc := cmdImageGraySrc;
        styleStr := '';
      }
      http (sprintf ('<span %s class="toolbar" %s title="%s">', onclickEvent, styleStr, cmdLabel));
        http (sprintf ('<img src="image/%s" border="0" alt="%s" />%s', imageSrc, cmdLabel, self.toolbarLabel(cmdLabel)));
      http ('</span>');
    ]]>
  </v:method>

  <v:method name="render_select" arglist="inout name any">
    <![CDATA[
      declare N any;
      declare S, T any;

      T := '';
      if (not isnull (self.i_maps))
        for (N := 0; N < length (self.i_maps); N := N + 2)
          if (self.i_maps[N] = name)
            T := self.i_maps[N+1];

  	  http (sprintf ('<select name="sel_%s">', name));
  	  http ('<option value="skip">--</option>');
      for (N := 0; N < length (self.i_Options); N := N + 2)
      {
        S := '';
        if (self.i_Options[N] = T)
          S := ' selected="selected"';
        http (sprintf ('<option value="%s"%s>%s</option>', self.i_Options[N], S, self.i_Options[N+1]));
      }
  	  http ('</select>');
	  ]]>
	</v:method>

  <v:method name="viewField" arglist="inout fValue any">
    <![CDATA[
       if (self.abAction = 'view')
         if (is_empty_or_null (fValue))
         {
           http ('&nbsp;');
         } else {
           if (internal_type (fValue) = 211)
           {
             http (left (cast (fValue as varchar), 10));
           } else {
             http (fValue);
           }
         }
	  ]]>
	</v:method>

  <v:method name="viewTags" arglist="inout fValue any">
    <![CDATA[
      if (self.abAction = 'view')
        if (is_empty_or_null (fValue))
        {
          http ('&nbsp;');
        } else {
          declare N integer;
          declare delimiter varchar;
          declare tags any;

          delimiter := '';
          tags := CAL.WA.tags2vector (fValue);
          for (N := 0; N < length (tags); N := N + 1)
          {
            http (delimiter);
            http (sprintf ('<a href="%s">%s</a>', SIOC..tag_iri (AB.WA.domain_iri (self.domain_id), tags[N]), tags[N]));
            delimiter := ', ';
          }
        }
    ]]>
  </v:method>

  <v:method name="viewTimeZone" arglist="inout fValue any">
    <![CDATA[
      if (is_empty_or_null (fValue))
         return '';
      return sprintf ('GMT %s%02d:00', case when cast (fValue as integer) < 0 then '-' else '+' end,  abs(cast (fValue as integer)));
	  ]]>
	</v:method>

  <v:method name="validateNode" arglist="in domain_id integer">
    <![CDATA[
      declare N, node_type, node_id, nodes, tmp any;

      node_id := AB.WA.node_id (self.abNode);
      node_type := AB.WA.node_type (self.abNode);

      if ((node_type = 'u') and (exists (select 1 from DB.DBA.SYS_USERS where U_ID = node_id)))
        goto _next;

      if (self.abNode in (AB.WA.make_node ('u', -1)))
        goto _next;

      self.abNode := AB.WA.make_node ('u', -1);

    _next:;
      tmp := '';
      nodes := split_and_decode (trim(self.abPath, '/'), 0, '\0\0/');
      for (N := 0; N < length (nodes) - 1; N := N + 1)
      {
        tmp := concat(tmp, '/', nodes[N]);
        if (not AB.WA.vector_contains (self.abState, tmp))
          self.abState := vector_concat (self.abState, vector(tmp));
      }
    ]]>
  </v:method>

  <v:method name="showTree" arglist="in level integer, in domain_id integer, in user_id integer, in node varchar, in path varchar">
    <![CDATA[
      declare N, isOpen integer;
      declare nodes, image, image2, alt, class any;

      if (isnull(self.abState))
        self.abState := vector();
      nodes := AB.WA.ab_tree2 (domain_id, user_id, node, path);
      if (level = 1)
        self.validateNode (domain_id);
      for (N := 0; N < length(nodes); N := N + 3) {
        if (level = 1) {
          http ('<div style="margin-left:3px; margin-top:3px; white-space: nowrap;">');
        } else {
          http ('<div style="margin-left:12px; white-space: nowrap;">');
        }
        image := 'plus.gif';
        image2 := 'folder_16.png';
        alt := 'Open Node';
        if (not AB.WA.ab_node_has_childs (domain_id, user_id, nodes[N+1], nodes[N+2])) {
          image := 'c.gif';
          image2 := 'folder_16.png';
        } else if (AB.WA.vector_contains(self.abState, nodes[N+2])) {
          image := 'minus.gif';
          image2 := 'folder_open_16.png';
          alt := 'Close Node';
        }

        if ((AB.WA.node_type(nodes[N+1]) = 'u') and (AB.WA.node_id(nodes[N+1]) = -1))
          image2 := 'group_16.png';
        if ((AB.WA.node_type(nodes[N+1]) = 'u') and (AB.WA.node_id(nodes[N+1]) >= 0))
          image2 := 'user_16.png';

        class := 'nolink_b';
        if (nodes[N+2] = self.abPath)
        {
          class := 'nolink_a';
          self.abName := nodes[N];
        }
        if (image = 'c.gif') {
          http (sprintf ('<img src="image/%s" border="0" width="11px" />', image));
        } else {
          http(sprintf('<a href="#" name="pt_toggle_%s" onclick="javascript: vspxPost (\'pt_browse\', \'pt_toggle\', \'%s\', \'pt_path\', \'%s\'); return false"><img src="image/%s" border="0" class="nolink" alt="%s" title="%s" /></a>', nodes[N+2], nodes[N+1], nodes[N+2], image, alt, alt));
        }
        http(sprintf('<a href="#" name="pt_node_%s" onclick="javascript: vspxPost (\'pt_browse\', \'pt_node\', \'%s\', \'pt_path\', \'%s\'); return false" class="nolink3 %s" alt="%s" title="%s" > <img src="image/%s" border="0" alt="" /> %s</a>', nodes[N+2], nodes[N+1], nodes[N+2], class, nodes[N], nodes[N], image2, nodes[N]));
        if (image = 'minus.gif')
          self.showTree(level+1, domain_id, user_id, nodes[N+1], nodes[N+2]);

        http ('</div>');
      }
    ]]>
  </v:method>

  <v:method name="shareNode" arglist="in person_id integer, in grants varchar, in override integer">
    <![CDATA[
      declare N, pos, id integer;
      declare name, V any;

      grants := replace(grants, ' ', '');
      grants := replace(grants, ',,', ',');
      grants := trim(grants, ',', '');
      grants := grants || ',';
      for (select U_ID, U_NAME from AB.WA.GRANTS, DB.DBA.SYS_USERS where G_GRANTER_ID = self.account_id and G_PERSON_ID = person_id and G_GRANTEE_ID = U_ID) do
      {
        name := U_NAME;
        id := U_ID;
        pos := strstr(grants, name || ',');
        if (isnull (pos))
        {
          if (override)
            delete from AB.WA.GRANTS where G_GRANTER_ID = self.account_id and G_GRANTEE_ID = id and G_PERSON_ID = person_id;
        } else {
          grants := replace(grants, name || ',', '');
        }
      }
      V := split_and_decode(trim(grants, ','), 0, '\0\0,');
      for (N := 0; N < length (V); N := N + 1)
      {
        id := (select U_ID from SYS_USERS where U_NAME = V[N]);
        if (not isnull(id))
          insert into AB.WA.GRANTS (G_GRANTER_ID, G_GRANTEE_ID, G_PERSON_ID)
            values(self.account_id, id, person_id);
      }
    ]]>
  </v:method>

  <v:method name="shareSelect" arglist="in person_id integer">
    <![CDATA[
      declare grants any;

      grants := '';
      for (select U_ID, U_NAME from AB.WA.GRANTS, DB.DBA.SYS_USERS where G_GRANTER_ID = self.account_id and G_GRANTEE_ID = U_ID and G_PERSON_ID = person_id) do
        grants := grants || cast (U_NAME as varchar) || ',';
      return trim (grants, ',');
    ]]>
  </v:method>

  <v:method name="contactUpdate" arglist="inout person_id integer, inout pFields any, inout pValues any">
    <![CDATA[
     if (self.v_tags <> '')
     {
       pFields := vector_concat (pFields, vector ('P_TAGS'));
       pValues := vector_concat (pValues, vector (self.v_tags));
     }
     if (length (pFields))
       AB.WA.contact_update3 ( person_id, self.domain_id, pFields, pValues);
    ]]>
  </v:method>

  <v:method name="resetImport" arglist="">
    <![CDATA[
      AB.WA.ab_graph_delete (self.i_iri);
      self.i_source := -1;
      self.i_type := -1;
      self.i_lName := '';
      self.i_lHost := '';
      self.i_lPort := '';
      self.i_lBase_dn := '';
      self.i_lBind_dn := '';
      self.i_lPassword := '';
      self.i_lMaps := null;
      self.i_maps := null;
      self.i_iri := null;
      self.i_contentItems := null;
      self.i_contentDepth := 0;
      self.i_contentDepth := 100;
      self.i_contentFollow := null;
      self.i_data := null;
      self.i_validation := null;
    ]]>
  </v:method>

  <v:method name="myTags" arglist="in fieldName varchar">
    <![CDATA[
      if ((select count (*) from AB.WA.TAGS where T_DOMAIN_ID = self.domain_id and T_COUNT > 0 and T_TAG <> '' order by T_TAG))
      {
        http ('<tr>');
        http ('<th valign="top">My Tags</th>');
          http ('<td>');
            for (select T_TAG from AB.WA.TAGS where T_DOMAIN_ID = self.domain_id and T_COUNT > 0 and T_TAG <> '' order by T_TAG) do
            {
              http (sprintf ('<a href="#" onclick="javascript: addTag(\'%s\', \'%s\');">%s</a> ', T_TAG, fieldName, T_TAG));
            }
          http ('</td>');
        http ('</tr>');
      }
    ]]>
  </v:method>

  <v:method name="windowOpen" arglist="in p_url varchar, in p_name varchar, in p_title varchar">
    <![CDATA[
      return  sprintf ('<a href="#" onclick="javascript: window.open (\'%s\', \'addressbook_%s_window\', \'top=100, left=100, scrollbars=yes, resize=yes, menubar=no, height=500, width=700\'); return false;" title="%s %s" class="link_ed">%s</a>', AB.WA.url_fix (sprintf ('%s%s', AB.WA.ab_url (self.domain_id), p_url), self.sid, self.realm), p_name, p_name, p_title, p_name);
    ]]>
  </v:method>

  <vm:pagetitle>AddressBook</vm:pagetitle>
  <vm:pagewrapper>
    <vm:header>
      AddressBook
    </vm:header>
    <vm:variables>
      <v:variable persist="0" name="abAction" type="varchar" param-name="action" default="'browse'" />
      <v:variable persist="0" name="abSubAction" type="varchar" default="''" />
      <v:variable persist="0" name="abSelected" type="any" default="null" />
      <v:variable persist="0" name="abScope" type="varchar" default="'MyContacts'" />
      <v:variable persist="0" name="abValue" type="varchar" default="null" />
      <v:variable persist="temp" name="abContact" type="any" default="''" />

      <v:variable persist="0" name="abName" type="varchar" default="''"/>
      <v:variable persist="0" name="abNode" type="varchar" default="'u#-1'"/>
      <v:variable persist="0" name="abPath" type="varchar" default="'/u#-1'"/>
      <v:variable persist="0" name="abState" type="any" default="null" />

      <v:variable name="abLabels" type="integer" default="1" />
      <v:variable name="abChars" type="integer" default="60" />
      <v:variable name="v_tabNo" param-name="tabNo" type="varchar" default="1"/>

      <v:variable persist="0" name="abStep" type="varchar" default="''" />
      <v:variable persist="0" name="abSteps" type="any" default="null" />
      <v:variable name="v_id" type="any" default="-1" />

      <v:variable name="v_kind" type="integer" default="0" />
      <v:variable name="v_name" type="varchar" default="''" />
      <v:variable name="v_title" type="varchar" default="''" />
      <v:variable name="v_fName" type="varchar" default="''" />
      <v:variable name="v_mName" type="varchar" default="''" />
      <v:variable name="v_lName" type="varchar" default="''" />
      <v:variable name="v_fullName" type="varchar" default="''" />
      <v:variable name="v_gender" type="varchar" default="''" />
      <v:variable name="v_birthday" type="date" default="null" />
      <v:variable name="v_iri" type="varchar" default="''" />
      <v:variable name="v_foaf" type="varchar" default="''" />

      <v:variable name="v_mail" type="varchar" default="''" />
      <v:variable name="v_web" type="varchar" default="''" />
      <v:variable name="v_icq" type="varchar" default="''" />
      <v:variable name="v_skype" type="varchar" default="''" />
      <v:variable name="v_aim" type="varchar" default="''" />
      <v:variable name="v_yahoo" type="varchar" default="''" />
      <v:variable name="v_msn" type="varchar" default="''" />

      <v:variable name="v_hCountry" type="varchar" default="''" />
      <v:variable name="v_hCity" type="varchar" default="''" />
      <v:variable name="v_hState" type="varchar" default="''" />
      <v:variable name="v_hCode" type="varchar" default="''" />
      <v:variable name="v_hAddress1" type="varchar" default="''" />
      <v:variable name="v_hAddress2" type="varchar" default="''" />
      <v:variable name="v_hTzone" type="varchar" default="''"/>
      <v:variable name="v_hLat" type="real" default="0.00"/>
      <v:variable name="v_hLng" type="real" default="0.00"/>
      <v:variable name="v_hPhone" type="varchar" default="''" />
      <v:variable name="v_hMobile" type="varchar" default="''"/>
      <v:variable name="v_hFax" type="varchar" default="''" />
      <v:variable name="v_hMail" type="varchar" default="''"/>
      <v:variable name="v_hWeb" type="varchar" default="''"/>

      <v:variable name="v_bCountry" type="varchar" default="''" />
      <v:variable name="v_bCity" type="varchar" default="''" />
      <v:variable name="v_bState" type="varchar" default="''" />
      <v:variable name="v_bCode" type="varchar" default="''" />
      <v:variable name="v_bAddress1" type="varchar" default="''" />
      <v:variable name="v_bAddress2" type="varchar" default="''" />
      <v:variable name="v_bTzone" type="varchar" default="''"/>
      <v:variable name="v_bLat" type="real" default="0.00"/>
      <v:variable name="v_bLng" type="real" default="0.00"/>
      <v:variable name="v_bPhone" type="varchar" default="''" />
      <v:variable name="v_bMobile" type="varchar" default="''"/>
      <v:variable name="v_bFax" type="varchar" default="''" />
      <v:variable name="v_bMail" type="varchar" default="''"/>
      <v:variable name="v_bWeb" type="varchar" default="''"/>
      <v:variable name="v_bIndustry" type="varchar" default="''"/>
      <v:variable name="v_bOrganization" type="varchar" default="''"/>
      <v:variable name="v_bDepartment" type="varchar" default="''" />
      <v:variable name="v_bJob" type="varchar" default="''"/>

      <v:variable name="v_tag" type="varchar" default="''" />
      <v:variable name="v_tags" type="varchar" default="''" />

      <v:variable name="v_grants" type="any" default="null"/>
      <v:variable name="v_override" type="integer" default="1"/>

      <v:variable name="v_category_id" type="integer" default="null" />
      <v:variable name="v_category_name" type="integer" default="null" />

      <v:variable name="i_source" type="any" default="-1"/>
      <v:variable name="i_type" type="any" default="-1"/>
      <v:variable name="i_lName" type="varchar" default="''"/>
      <v:variable name="i_lHost" type="varchar" default="''"/>
      <v:variable name="i_lPort" type="varchar" default="'389'"/>
      <v:variable name="i_lBase_dn" type="varchar" default="''"/>
      <v:variable name="i_lBind_dn" type="varchar" default="''"/>
      <v:variable name="i_lPassword" type="varchar" default="''"/>
      <v:variable name="i_lSearch" type="varchar" default="'(cn=*)'"/>
      <v:variable name="i_lMaps" type="any" default="null"/>
      <v:variable persist="temp" name="i_Options" type="any" default="null" />
      <v:variable persist="temp" name="i_Items" type="any" default="null" />

      <v:variable name="i_data" type="varchar" default="null"/>
      <v:variable name="i_iri" type="varchar" default="null" />
      <v:variable name="i_contentItems" type="any" default="null" />
      <v:variable name="i_contentDepth" type="integer" default="0" />
      <v:variable name="i_contentLimit" type="integer" default="100" />
      <v:variable name="i_contentFollow" type="any" default="null" />
      <v:variable name="i_validation" type="varchar" default="null" />
      <v:variable name="i_maps" type="any" default="null" />

      <v:variable name="ve_id" type="any" default="-1" />
      <v:variable name="ve_name" type="varchar" default="''" />
      <v:variable name="ve_type" type="varchar" default="''" />
      <v:variable name="ve_update_type" type="integer" default="0" />
      <v:variable name="ve_update_period" type="varchar" default="''" />
      <v:variable name="ve_update_freq" type="integer" default="0" />
      <v:variable name="ve_options" type="any" default="null" />
    </vm:variables>
    <vm:pagebody>
      <v:before-data-bind>
        <![CDATA[
          self.abLabels := cast (get_keyword ('tbLabels', self.settings, '1') as integer);
          self.abChars := cast (get_keyword ('chars', self.settings, '60') as integer);

          if (get_keyword ('tab', e.ve_params, '') = 'shared')
          {
            self.abScope := 'MySharedContacts';
            self.abAction := 'browse';
            self.abSubAction := '';
            self.abValue := '';
          }
            
          self.mode_test();
        ]]>
      </v:before-data-bind>
      <?vsp 
        declare sparqlUrl, graphIri any;
        
        sparqlUrl := 'http://' || SIOC..get_cname () || '/sparql';
        graphIri := SIOC..get_graph ();
        http (sprintf ('<input type="hidden" name="sparqlUrl" id="sparqlUrl" value="%s?default-graph-uri=%U&query=%U&format=%U"/>', sparqlUrl, graphIri, 'DESCRIBE <_RDF_>', 'application/sparql-results+xml'));
        http (         '<input type="hidden" name="tbHidden" id="tbHidden" value="" />');
        http (sprintf ('<input type="hidden" name="abSubAction" id="abSubAction" value="%s" />', self.abSubAction));
      ?>
        <?vsp
          if (0)
          {
        ?>
            <v:button name="toolbar" action="simple" style="url" value="Submit">
              <v:on-post>
                <![CDATA[
                  declare N integer;
                  declare cmd any;

                  cmd := get_keyword ('tbHidden', e.ve_params, '');
                if (cmd = 'MyContacts')
                {
                    self.abScope := cmd;
                    self.abAction := 'browse';
                  self.abSubAction := '';
                  self.abValue := '';
                  }
                if (cmd = 'MySharedContacts')
                {
                    self.abScope := cmd;
                    self.abAction := 'browse';
                  self.abSubAction := '';
                  self.abValue := '';
                  }
                if (cmd = 'create')
                {
                    self.abAction := cmd;

                    self.v_id := -1;
                  self.v_kind := 0;
                    self.v_tags := '';
                    self.v_name := '';
                    self.v_title := '';
                    self.v_fName := '';
                    self.v_mName := '';
                    self.v_lName := '';
                    self.v_fullName := '';
                    self.v_gender := '';
                    self.v_birthday := null;
                  self.v_iri := '';
                    self.v_foaf := '';

                    self.v_mail := '';
                    self.v_web := '';
                    self.v_icq := '';
                    self.v_skype := '';
                    self.v_aim := '';
                    self.v_yahoo := '';
                    self.v_msn := '';
                    self.v_tags := '';

                    self.v_hCountry := '';
                    self.v_hCity := '';
                    self.v_hState := '';
                    self.v_hCode := '';
                    self.v_hAddress1 := '';
                    self.v_hAddress2 := '';
                    self.v_hTzone := '';
                    self.v_hLat := null;
                    self.v_hLng := null;
                    self.v_hMail := '';
                    self.v_hWeb := '';
                    self.v_hPhone := '';
                    self.v_hMobile := '';
                    self.v_hFax := '';

                    self.v_bCountry := '';
                    self.v_bCity := '';
                    self.v_bState := '';
                    self.v_bCode := '';
                    self.v_bAddress1 := '';
                    self.v_bAddress2 := '';
                    self.v_bTzone := '';
                    self.v_bLat := null;
                    self.v_bLng := null;
                    self.v_bMail := '';
                    self.v_bWeb := '';
                    self.v_bPhone := '';
                    self.v_bMobile := '';
                    self.v_bFax := '';
                    self.v_bIndustry := '';
                    self.v_bOrganization := '';
                    self.v_bDepartment := '';
                    self.v_bJob := '';
                    self.v_grants := '';

                  self.v_category_id := null;
                  self.v_category_name := null;
                }
                if (cmd = 'tag')
                {
                    self.abAction := cmd;
                    self.abSelected := vector();
                  for (N := 0; N < length(e.ve_params); N := N + 4)
                  {
                      if (e.ve_params[N] = 'cb_item')
                        self.abSelected := vector_concat(self.abSelected, vector(e.ve_params[N+1]));
                    }
                  }
                if (cmd = 'grants')
                {
                    self.v_grants := '';
                    self.abAction := cmd;
                    self.abSelected := vector();
                  for (N := 0; N < length(e.ve_params); N := N + 4)
                  {
                      if (e.ve_params[N] = 'cb_item')
                        self.abSelected := vector_concat(self.abSelected, vector(e.ve_params[N+1]));
                    }
                  }
                if (cmd = 'delete')
                {
                    declare id integer;

                  for (N := 0; N < length(e.ve_params); N := N + 4)
                  {
                    if (e.ve_params[N] = 'cb_item')
                    {
                        id := cast(e.ve_params[N+1] as integer);
                        AB.WA.contact_delete(id, self.domain_id);
                      }
                    }
                  }
                if (cmd = 'import')
                {
                  self.resetImport ();
                    self.abAction := cmd;
                    self.abStep := '1';
                  self.abSteps  := vector ();
                    self.v_tag := '';
                  }
                if (cmd = 'export')
                {
                    self.abAction := cmd;
                    self.abSelected := vector();
                  for (N := 0; N < length(e.ve_params); N := N + 4)
                  {
                      if (e.ve_params[N] = 'cb_item')
                        self.abSelected := vector_concat(self.abSelected, vector(e.ve_params[N+1]));
                    }
                  }

                _end:
                  self.vc_data_bind(e);
                 ]]>
               </v:on-post>
            </v:button>
        <?vsp
          }
        ?>
        <div class="toolbar">
        <?vsp
          self.toolbarShow ('', 'My Contacts', 'onclick="javascript: toolbarPost(\'MyContacts\');"', 'ab_32.png', '');
          self.toolbarShow ('', 'Shared Contacts', 'onclick="javascript: toolbarPost(\'MySharedContacts\');"', 'ab_shared_32.png', '');
        ?>

          <img src="image/c.gif" height="32" width="2" border="0" class="toolbar" />

        <?vsp
          self.toolbarShow ('import', 'Import', 'onclick="javascript: toolbarPost(\'import\');"', 'impt_32.png', 'grey_impt_32.png');
          self.toolbarShow ('export', 'Export', 'onclick="javascript: toolbarPost(\'export\');"', 'exp_32.png', 'grey_exp_32.png');
        ?>

          <img src="image/c.gif" height="32" width="2" border="0" class="toolbar" />

        <?vsp
          self.toolbarShow ('create', 'New Contact', 'onclick="javascript: toolbarPost(\'create\');"', 'ab_add_32.png', 'grey_ab_add_32.png');
        ?>

          <img src="image/c.gif" height="32" width="2" border="0" class="toolbar" />

        <vm:if test="self.toolbarEnable('tag')">
          <span id="tbTag" class="toolbar" style="display: none; cursor: pointer;" onclick="javascript: toolbarPost('tag');" title="Tag">
            <img src="image/tag_32.png" border="0" alt="Tag" /><?vsp http (self.toolbarLabel('Tag'));?>
          </span>
        </vm:if>
          <span id="tbTag_gray" class="toolbar" style="display: inline;">
            <img src="image/grey_tag_32.png" border="0" alt="Tag" /><?vsp http (self.toolbarLabel('Tag'));?>
          </span>

        <vm:if test="self.toolbarEnable('grants')">
          <span id="tbSharing" class="toolbar" style="display: none; cursor: pointer;" onclick="javascript: toolbarPost('grants');" title="Sharing">
            <img src="image/grey_grants_32.png" border="0" alt="Sharing"/><?vsp http (self.toolbarLabel('Sharing'));?>
          </span>
        </vm:if>
          <span id="tbSharing_gray" class="toolbar" style="display: inline;">
            <img src="image/grey_grants_32.png" border="0" alt="Sharing"/><?vsp http(self.toolbarLabel('Sharing'));?>
          </span>

        <vm:if test="self.toolbarEnable('delete')">
          <span id="tbDelete" class="toolbar" style="display: none; cursor: pointer;" onclick="javascript: if (confirmAction('Are you sure that you want to delete selected items?', document.F1, 'cb_', 'No items were selected for deletion.')) toolbarPost('delete');" title="Delete">
            <img src="image/del_32.png" border="0" alt="Delete" /><?vsp http (self.toolbarLabel('Delete'));?>
            </span>
        </vm:if>
          <span id="tbDelete_gray" class="toolbar" style="display: inline;">
            <img src="image/grey_del_32.png" border="0" alt="Delete" /><?vsp http (self.toolbarLabel('Delete'));?>
            </span>

        </div>
        <div style="clear: both;" />

      <vm:if test="self.abAction <> 'settings'">
      <div class="ab_main">
        <?vsp
          if (0)
          {
        ?>
            <v:button name="pt_browse" action="simple" style="url" value="Submit">
              <v:on-post>
                <![CDATA[
                  declare node, path, action any;

                  -- toggle
                  path := get_keyword ('pt_path', e.ve_params, '');
                  node := get_keyword ('pt_toggle', e.ve_params, get_keyword ('pt_node', e.ve_params, ''));
                  if (node <> '')
                  {
                    if (AB.WA.vector_contains (self.abState, path))
                    {
                      if (get_keyword ('pt_toggle', e.ve_params, '') <> '')
                        self.abState := AB.WA.vector_cut (self.abState, path);
                      if (self.abPath like concat (path, '%'))
                      {
                        self.abNode := node;
                        self.abPath := path;
                      }
                    } else {
                      self.abState := vector_concat (self.abState, vector(path));
                    }
                    self.abAction := 'browse';
                  }

                  -- node
                  node := get_keyword ('pt_node', e.ve_params, '');
                  if (node <> '')
                  {
                    self.abAction := 'browse';
                    self.abNode := node;
                    self.abPath := path;
                  }

                  -- action
                  action := get_keyword ('pt_action', e.ve_params, '');
                  if (action <> '')
                  {
                    if (action = 'delete')
                    {
                    self.v_id := cast(get_keyword ('pt_value', e.ve_params, '0') as integer);
                      AB.WA.contact_delete (self.v_id, self.domain_id);
                    }
                    if (action = 'edit')
                    {
                      self.v_id := cast(get_keyword ('pt_value', e.ve_params, '0') as integer);
                      self.abAction := action;
                    }
                    if (action = 'view')
                    {
                      self.v_id := cast(get_keyword ('pt_value', e.ve_params, '0') as integer);
                      self.abAction := action;
                    }
                    if (action = 'tags')
                    {
                      self.abAction := 'browse';
                      self.abSubAction := action;
                      self.abValue := lcase (get_keyword ('pt_value', e.ve_params, ''));
                    }
                    if (action = 'category')
                    {
                      self.abAction := 'browse';
                      self.abSubAction := action;
                      self.abValue := lcase (get_keyword ('pt_value', e.ve_params, ''));
                    }
                  }
                  self.vc_data_bind (e);
               ]]>
              </v:on-post>
            </v:button>
        <?vsp
          }
        ?>
        <div class="ab_left">
            <div id="panelbar" class="panelbar">
              <vm:if test="self.domain_id > 0">
                <div id="pb_1">Data Portability (Feeds)</div>
                <div id="pc_1" style="display: none;">
                  <div class="left_container">
                    <?vsp
                      declare exit handler for not found;

                      declare S varchar;
                      declare lat, lng any;

                      select WAUI_LAT, WAUI_LNG into lat, lng from DB.DBA.WA_USER_INFO where WAUI_U_ID = self.account_id;
                      if (not is_empty_or_null(lat) and not is_empty_or_null (lng) and exists (select 1 from ODS..SVC_HOST, ODS..APP_PING_REG where SH_NAME = 'GeoURL' and AP_HOST_ID = SH_ID and AP_WAI_ID = self.domain_id))
                      {
                        http (sprintf('<a href="http://geourl.org/near?p=%U" title="GeoURL link" alt="GeoURL link" class="gems noapp"><img src="http://i.geourl.org/geourl.png" border="0"/></a>', AB.WA.ab_url (self.domain_id)));
                        http ('<div style="border-top: 1px solid #7f94a5;"></div>');
                      }

                      S := AB.WA.dav_url (self.domain_id);
                      http (sprintf ('<a href="%sAddressBook.%s" target="_blank" title="%s export" alt="%s export" class="gems noapp"><img src="image/rss-icon-16.gif" border="0" alt="%s export" /> %s</a>', S, 'rss', 'RSS', 'RSS', 'RSS', 'RSS'));
                      http (sprintf ('<a href="%sAddressBook.%s" target="_blank" title="%s export" alt="%s export" class="gems noapp"><img src="image/blue-icon-16.gif" border="0" alt="%s export" /> %s</a>', S, 'atom', 'ATOM', 'ATOM', 'ATOM', 'Atom'));
                      http (sprintf ('<a href="%sAddressBook.%s" target="_blank" title="%s export" alt="%s export" class="gems noapp"><img src="image/rdf-icon-16.gif" border="0" alt="%s export" /> %s</a>', S, 'rdf', 'RDF', 'RDF', 'RDF', 'RDF'));

                      http ('<div style="border-top: 1px solid #7f94a5;"></div>');
                      http (sprintf ('<a href="%s" target="_blank" title="FOAF export" alt="FOAF export" class="gems noapp"><img src="image/foaf.png" border="0" alt="FOAF export" /> FOAF</a>', AB.WA.foaf_url (self.domain_id)));

                      http ('<div style="border-top: 1px solid #7f94a5;"></div>');
                      S := sprintf ('http://%s/dataspace/%U/addressbook/%U/', DB.DBA.wa_cname (), AB.WA.domain_owner_name (self.domain_id), AB.WA.utf2wide (AB.WA.domain_name (self.domain_id)));
                      http (sprintf ('<a href="%ssioc.%s" title="%s" alt="%s" class="gems noapp"><img src="image/rdf-icon-16.gif" border="0" alt="%s export" /> %s</a>', S, 'rdf', 'SIOC (RDF/XML)', 'SIOC (RDF/XML)', 'SIOC (RDF/XML)', 'SIOC (RDF/XML)'));
                      http (sprintf ('<a href="%ssioc.%s" title="%s" alt="%s" class="gems noapp"><img src="image/rdf-icon-16.gif" border="0" alt="%s export" /> %s</a>', S, 'ttl', 'SIOC (N3/Turtle)', 'SIOC (N3/Turtle)', 'SIOC (N3/Turtle)', 'SIOC (N3/Turtle)'));
                    ?>
                  </div>
                </div>
                <vm:if test="self.abScope = 'MyContacts'">
                  <div id="pb_2">Categories</div>
                  <div id="pc_2" style="display: none;">
                    <div class="left_container">
                      <?vsp
                        http ('<a id="c_0" href="javascript: myCategory(\'0\');" class="gems noapp">All Categories</a>');
                        for (select C_ID, C_NAME from AB.WA.CATEGORIES where C_DOMAIN_ID = self.domain_id order by C_NAME) do
                        {
                          http (sprintf ('<a id="c_%d" href="javascript: myCategory(\'%d\');" class="gems noapp">%s</a>', C_ID, C_ID, C_NAME));
                        }
                      ?>
                    </div>
                  </div>
                </vm:if>
              </vm:if>
              <div id="pb_3">
              <?vsp
                if (self.abScope = 'MyContacts')
                {
                  http ('Tags');
                } else {
                  http ('Shared Contacts');
                }
              ?>
              </div>
              <div id="pc_3" style="display: none;">
            <?vsp
                if (self.abScope = 'MyContacts')
                {
                declare _done, tMin, tMax integer;
                declare tClass, tStyle varchar;

                select max(T_COUNT),
                       min(T_COUNT)
                  into tMax, tMin
                  from AB.WA.TAGS
                 where T_DOMAIN_ID = self.domain_id
                   and T_COUNT > 0;

                _done := 0;  
                for (select T_TAG, T_COUNT
                       from AB.WA.TAGS
                      where T_DOMAIN_ID = self.domain_id
                        and T_COUNT > 0
                      order by T_TAG) do
                {
                  _done := 1;  
                  tStyle := ODS.WA.tag_style(T_COUNT, tMin, tMax);
                  tClass := '';
                    if ((self.abSubaction = 'tags') and (self.abValue = T_TAG))
                    tClass := 'nolink_a';
                  http (sprintf ('<a id="t_tag_%s" name="pt_tag_%s" href="javascript: myTags(\'%s\');" class="%s" about="%U"><span class="%s" style="%s">%s</span></a> ', AB.WA.tag_id(T_TAG), T_TAG, T_TAG, 'app', SIOC..addressbook_tag_iri (self.account_id, T_TAG), tClass, tStyle, T_TAG));
                }
              }
              if (self.abScope = 'MySharedContacts')
                {
                self.showTree(1, self.domain_id, self.account_id, AB.WA.make_node('r', 2), '');
                }
            ?>
          </div>

            </div>

        </div>
        <div class="ab_right">
          <v:template type="simple" enabled="--case when (self.abAction = 'browse') then 1 else 0 end">
            <?vsp
              declare nodeName, image any;

              self.mode_test();

              image := '';
                if (self.abScope = 'MyContacts')
                {
                nodeName := 'My Contacts';
                  if (self.abSubaction = 'tags')
                  {
                    if (not is_empty_or_null(self.abValue))
                    {
                  image := 'tag_16.png';
                      nodeName := nodeName || ', Tag: ' || self.abValue;
                    }
                  }
                  if (self.abSubaction = 'category')
                  {
                    if (is_empty_or_null (cast (self.abValue as integer)))
                    {
                      nodeName := nodeName || ': All categories';
                    } else {
                      nodeName := nodeName || ', Category: ' || (select C_NAME from AB.WA.CATEGORIES where C_ID = cast (self.abValue as integer));
                }
              }
                }
                if (self.abScope = 'MySharedContacts')
                {
                image := 'group_16.png';
                if ((AB.WA.node_type (self.abNode) = 'u') and (AB.WA.node_id (self.abNode) >= 0))
                  image := 'user_16.png';
                nodeName := self.abName;
              }

              --nodeName := AB.WA.stringCut (coalesce(nodeName, ''), self.chars);
              if (image <> '')
                image := sprintf ('<img src="image/%s" border="0" alt="" /> ', image);

                http('<div id="ab_header">');
                if (not is_empty_or_null(nodeName))
                {
                  http(sprintf('<div style="float: left">%s%s</div>', image, nodeName));
              }
                http ('<div style="float: right"><span id="navigation"></span></div>');
                http('</div>');
            ?>
              <div style="height: 477px; overflow-y: auto; overflow-x: hidden;">
            <v:data-source name="dsrc" expression-type="sql" nrows="0" initial-offset="0">
              <v:before-data-bind>
                <![CDATA[
                  declare data any;

                  self.mode_test();

                  if (self.abScope = 'MyContacts')
                  {
                    AB.WA.xml_set('MyContacts', data, 1);
                      if (self.abSubAction = 'tags')
                      {
                        if (not is_empty_or_null (self.abValue))
                          AB.WA.xml_set('tags', data, self.abValue);
                      }
                      if (self.abSubAction = 'category')
                      {
                        if (not is_empty_or_null (cast (self.abValue as integer)))
                          AB.WA.xml_set('category', data, self.abValue);
                      }
                    control.ds_sql := AB.WA.search_sql (self.domain_id, self.account_id, data);
                    }
                    else if (self.abScope = 'MySharedContacts')
                    {
                      if ((AB.WA.node_type(self.abNode) = 'u') and (AB.WA.node_id(self.abNode) = -1))
                      {
                      control.ds_sql := 'select *
                                           from (select distinct
                                                        U_ID                           P_ID,
                                                        AB.WA.make_node(\'u\', U_ID)   P_NODE,
                                                        U_NAME                         P_NAME,
                                                        null                           P_TAGS,
                                                        null                           P_UPDATED,
                                                        null                           P_CREATED
                                                   from AB.WA.GRANTS,
                                                        DB.DBA.SYS_USERS
                                                  where G_GRANTEE_ID = <USER_ID>
                                                    and G_GRANTER_ID = U_ID) x
                                            where 1 = 1';
                      control.ds_sql := replace(control.ds_sql, '<USER_ID>', cast (self.account_id as varchar));
                      }
                      else if ((AB.WA.node_type(self.abNode) = 'u') and (AB.WA.node_id(self.abNode) >= 0))
                      {
                      control.ds_sql := 'select *
                                           from (select a.P_ID                          P_ID,
                                                        AB.WA.make_node(\'p\', a.P_ID)  P_NODE,
                                                        a.P_NAME                        P_NAME,
                                                        a.P_TAGS                        P_TAGS,
                                                        a.P_UPDATED                     P_UPDATED,
                                                        a.P_CREATED                     P_CREATED
                                                   from AB.WA.PERSONS a,
                                                        AB.WA.GRANTS b
                                                  where a.P_ID = b.G_PERSON_ID
                                                    and b.G_GRANTER_ID = <ID>
                                                    and b.G_GRANTEE_ID = <USER_ID>) x
                                            where 1 = 1';
                      control.ds_sql := replace(control.ds_sql, '<ID>', AB.WA.node_suffix(self.abNode));
                      control.ds_sql := replace(control.ds_sql, '<USER_ID>', cast (self.account_id as varchar));
                    }
                  }

                  control.ds_nrows := AB.WA.settings_rows (self.settings);
                  control.ds_parameters := vector ();
                ]]>
              </v:before-data-bind>
                <v:after-data-bind>
                  control.ds_make_statistic ();
                </v:after-data-bind>
            </v:data-source>

            <v:data-set name="ds" data-source="self.dsrc" scrollable="1">

              <v:template name="ds_header" type="simple" name-to-remove="table" set-to-remove="bottom" >
                <table id="contacts" class="ab_grid" cellspacing="0">
                  <thead class="sortHeader">
                    <tr>
                      <v:template type="simple" enabled="--case when ((self.account_role in ('public', 'guest')) or (self.abScope = 'MySharedContacts')) then 0 else 1 end">
                        <th class="checkbox" width="1%">
                          <input type="checkbox" name="cb_all" value="Select All" onclick="selectAllCheckboxes(this, 'cb_item')" />
                        </th>
                      </v:template>
                      <th class="last">
                        Name
                      </th>
                    </tr>
                  </thead>
                </table>
              </v:template>

              <v:template name="ds_repeat" type="repeat" name-to-remove="" set-to-remove="">

                <v:template name="ds_browse" type="browse" name-to-remove="table" set-to-remove="both">
                  <table>
                    <tr>
                      <v:template type="simple" enabled="--case when ((self.account_role in ('public', 'guest')) or (self.abScope = 'MySharedContacts')) then 0 else 1 end">
                        <td align="center" valign="top">
                          <?vsp
                            declare S varchar;

                            S := '';
                            if (self.abContact = ((control.vc_parent) as vspx_row_template).te_column_value('P_ID'))
                              S := 'checked="checked"';

                            http (sprintf ('<input type="checkbox" name="cb_item" value="%d" %s onclick="selectCheck(this, \'cb_item\')" />', ((control.vc_parent) as vspx_row_template).te_column_value('P_ID'), S));
                          ?>
                        </td>
                      </v:template>
                      <td valign="top">
                        <?vsp
                          declare N, id, did integer;
                              declare tmp, title, permissions, actions, tags any;

                            if ((self.abScope = 'MySharedContacts') and (AB.WA.node_type(self.abNode) = 'u') and (AB.WA.node_id(self.abNode) = -1))
                            {
                            http (sprintf ('<div style="float: left; font-weight: bold;">%s</div>', AB.WA.stringCut((control as vspx_row_template).te_column_value('P_NAME'), self.abChars)));
                            goto _skip;
                          }

                          id := (control as vspx_row_template).te_column_value('P_ID');
                          did := (control as vspx_row_template).te_column_value('P_DOMAIN_ID');
                          title := (control as vspx_row_template).te_column_value('P_NAME');
                          tags := (control as vspx_row_template).te_column_value('P_TAGS');
                              permissions := AB.WA.person_permissions (id, self.domain_id, self.account_role);

                              tmp := 'view';
                              if (permissions = 'W')
                                tmp := 'edit';
                              http (sprintf ('<div style="float: left; font-weight: bold;"><a id="ab_%d" href="javascript: vspxPost (\'pt_browse\', \'pt_action\', \'%s\', \'pt_value\', \'%d\');" title="%s \'%s\'" class="%s link_ed" about="%U">%s</a></div>', id, tmp, id, initcap (tmp), title, 'app', SIOC..addressbook_contact_iri (self.domain_id, id), AB.WA.stringCut(title, self.abChars)));
                          
                          actions := '';
                              if (permissions = 'W')
                                actions := actions || either (equ (actions, ''), '', ' | ') || self.windowOpen (sprintf ('annotea.vspx?oid=%d', id), 'annotate', title);
                              if (AB.WA.discussion_check () and AB.WA.conversation_enable (self.domain_id))
                                actions := actions || either (equ(actions, ''), '', ' | ') || self.windowOpen (sprintf ('conversation.vspx?id=%d', id), 'discuss', title);
                              if (permissions = 'W')
                                actions := actions || either (equ (actions, ''), '', ' | ') || self.windowOpen (sprintf ('invite.vspx?0id=%d', id), 'invite', title);

                          http ('<div style="float: right; text-align: right; padding-right: 0.3em;">');
                          http (actions);
                          http ('</div>');

                            if (not is_empty_or_null(tags))
                            {
                            http ('<br style="clear: both;" /><i>Tags: ');
                            tags := split_and_decode (tags, 0, '\0\0,');
                              for (N := 0; N < length(tags); N := N + 1)
                              {
                              http (sprintf ('<a id="tag_%d_%s" name="pt_tag_%s" href="javascript: myTags(\'%s\');" class="%s" about="%U">%s</a> ', id, AB.WA.tag_id (tags[N]), tags[N], tags[N], 'app', SIOC..addressbook_tag_iri (self.account_id, tags[N]), tags[N]));
                              if (N <> length(tags)-1)
                                http (' | ');
                            }
                            http ('</i>');
                          }
                        _skip:;
                        ?>
                      </td>
                    </tr>
                  </table>
                </v:template>

              </v:template>

              <v:template name="ds_footer" type="simple" name-to-remove="table" set-to-remove="top">
                <table>
                </table>
              </v:template>

                <span id="ds_navigation">
                  <vm:ds-navigation data-set="ds" />
                </span>
            </v:data-set>
              </div>
            <script type="text/javascript">
              <![CDATA[
                coloriseTable('contacts');
                  exchangeHTML();

                var objForm = document.forms['F1'];
                  for (var i = 0; i < objForm.elements.length; i++)
                  {
                  var o = objForm.elements[i];
                  if (o != null && o.type == 'checkbox' && !o.disabled && o.name.indexOf ('cb_item') != -1)
                    coloriseRow(getParent(o, 'tr'), o.checked);
                }
                enableToolbars (objForm, 'cb_item');
              ]]>
            </script>
          </v:template>

          <v:template type="simple" enabled="--case when (self.abAction = 'tag') then 1 else 0 end">
            <div class="new-form-header">
              <v:label format="%s" value="Tag contact(s)" />
            </div>
            <div class="new-form-body">
              <table cellspacing="0">
                <tr>
                  <th>
                    <v:label for="t_tag" value="Tags (comma-separated)" />
                  </th>
                  <td>
                    <v:text name="t_tag" null-value="''" value="--self.v_tag" xhtml_class="textbox" xhtml_size="60" />
                  </td>
                </tr>
                  <?vsp self.myTags ('t_tag'); ?>
              </table>
            </div>
            <div class="new-form-footer">
              <v:button action="simple" value="Tag" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    self.v_tag := AB.WA.tag_prepare(self.t_tag.ufl_value);
                      if (not AB.WA.validate_tags(self.v_tag))
                      {
                      self.vc_error_message := 'The expression is not valid tag(s).';
                        self.vc_is_valid := 0;
                      return;
                    }
                    declare N integer;

                      for (N := 0; N < length(self.abSelected); N := N + 1)
                      {
                      self.v_tags := AB.WA.contact_tags_select(self.abSelected[N], self.domain_id);
                      self.v_tags := AB.WA.tags_join(self.v_tags, self.v_tag);
                      AB.WA.contact_tags_update (self.abSelected[N], self.domain_id, self.v_tags);
                    }

                    self.v_tag := '';
                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
              <v:button action="simple" name="t_cancel" value="Cancel" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    self.v_tag := '';
                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
            </div>
          </v:template>

          <v:template type="simple" enabled="--case when (self.abAction = 'grants') then 1 else 0 end">
            <v:before-data-bind>
              <![CDATA[
                self.v_grants := get_keyword ('grants', self.vc_page.vc_event.ve_params, self.v_grants);
              ]]>
            </v:before-data-bind>
            <div class="new-form-header">
              <v:label value="--''">
                <v:after-data-bind>
                  <![CDATA[
                    declare N integer;
                    declare name varchar;

                    control.ufl_value := 'Sharings for ';
                      for (N := 0; N < length(self.abSelected); N := N + 1)
                      {
                        if (length (control.ufl_value) < 60)
                        {
                        name := '''' || (select P_NAME from AB.WA.PERSONS where P_ID = self.abSelected[N]) || '''';
                        if (N <> 0)
                          name := ', ' || name;
                        control.ufl_value := control.ufl_value || name;
                      }
                    }
                  ]]>
                </v:after-data-bind>
              </v:label>
            </div>
            <div class="new-form-body">
              <table cellspacing="0">
                <tr>
                  <th>
                    <v:label for="s_grants" value="User(s)" />
                  </th>
                  <td>
                    <v:text name="s_grants" null-value="--''" value="--self.v_grants" xhtml_class="textbox" xhtml_size="60" xhtml_title="User names must be comma delimited!" />
                    <input type="button" value="Select" onclick="javascript: windowShow('users.vspx?mode=u&dst=m&amp;params=s_grants:s1;',520)" class="button" />
                    <input type="button" value="Clear" onclick="javascript: document.F1.elements['s_grants'].value = ''" class="button" />
                  </td>
                </tr>
                <tr>
                  <th/>
                  <td>
                    <v:check-box name="s_override" initial-checked="self.v_override" xhtml_id="s_override" value="1" />
                    <b><vm:label for="s_override" value="Override current sharings"/></b>
                  </td>
                </tr>
              </table>
            </div>
            <div class="new-form-footer">
                <v:button action="simple" name="s_save" value="Save" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    declare N integer;

                    self.v_grants := trim(self.s_grants.ufl_value);
                    self.v_override := self.s_override.ufl_selected;

                    for (N := 0; N < length(self.abSelected); N := N + 1)
                      self.shareNode (self.abSelected[N], self.v_grants, self.v_override);

                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
              <v:button action="simple" name="s_cancel" value="Cancel" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
            </div>
          </v:template>

          <v:template type="simple" enabled="--case when (self.abAction in ('create', 'edit', 'view')) then 1 else 0 end">
            <v:before-data-bind>
              <![CDATA[
                declare params any;

                  declare exit handler for not found goto _end;

                params := self.vc_page.vc_event.ve_params;
                if (isnull (get_keyword ('ab_name', params)))
                  self.v_tabNo := '1';
                  if ((self.abAction in ('edit', 'view')) and isnull (get_keyword ('ab_name', params)))
                  {
                  select coalesce (P_KIND, 0),
                         P_NAME,
                         P_TITLE,
                         P_FIRST_NAME,
                         P_MIDDLE_NAME,
                         P_LAST_NAME,
                         P_FULL_NAME,
                         P_GENDER,
                         P_BIRTHDAY,
                         P_IRI,
                         P_FOAF,
                         P_MAIL,
                         P_WEB,
                         P_ICQ,
                         P_SKYPE,
                         P_AIM,
                         P_YAHOO,
                         P_MSN,
                         P_H_COUNTRY,
                         P_H_CITY,
                         P_H_STATE,
                         P_H_CODE,
                         P_H_ADDRESS1,
                         P_H_ADDRESS2,
                         P_H_TZONE,
                         P_H_LAT,
                         P_H_LNG,
                         P_H_PHONE,
                         P_H_MOBILE,
                         P_H_FAX,
                         P_H_MAIL,
                         P_H_WEB,
                         P_B_COUNTRY,
                         P_B_CITY,
                         P_B_STATE,
                         P_B_CODE,
                         P_B_ADDRESS1,
                         P_B_ADDRESS2,
                         P_B_TZONE,
                         P_B_LAT,
                         P_B_LNG,
                         P_B_PHONE,
                         P_B_MOBILE,
                         P_B_FAX,
                         P_B_INDUSTRY,
                         P_B_ORGANIZATION,
                         P_B_DEPARTMENT,
                         P_B_JOB,
                         P_B_MAIL,
                         P_B_WEB,
                           P_TAGS,
                           C_ID,
                           C_NAME
                    into self.v_kind,
                         self.v_name,
                         self.v_title,
                         self.v_fName,
                         self.v_mName,
                         self.v_lName,
                         self.v_fullName,
                         self.v_gender,
                         self.v_birthday,
                         self.v_iri,
                         self.v_foaf,
                         self.v_mail,
                         self.v_web,
                         self.v_icq,
                         self.v_skype,
                         self.v_aim,
                         self.v_yahoo,
                         self.v_msn,
                         self.v_hCountry,
                         self.v_hCity,
                         self.v_hState,
                         self.v_hCode,
                         self.v_hAddress1,
                         self.v_hAddress2,
                         self.v_hTzone,
                         self.v_hLat,
                         self.v_hLng,
                         self.v_hPhone,
                         self.v_hMobile,
                         self.v_hFax,
                         self.v_hMail,
                         self.v_hWeb,
                         self.v_bCountry,
                         self.v_bCity,
                         self.v_bState,
                         self.v_bCode,
                         self.v_bAddress1,
                         self.v_bAddress2,
                         self.v_bTzone,
                         self.v_bLat,
                         self.v_bLng,
                         self.v_bPhone,
                         self.v_bMobile,
                         self.v_bFax,
                         self.v_bIndustry,
                         self.v_bOrganization,
                         self.v_bDepartment,
                         self.v_bJob,
                         self.v_bMail,
                         self.v_bWeb,
                           self.v_tags,
                           self.v_category_id,
                           self.v_category_name
                    from AB.WA.PERSONS
                             left join AB.WA.CATEGORIES on C_ID = P_CATEGORY_ID
                   where P_ID = self.v_id;
                  self.v_grants := self.shareSelect (self.v_id);
                }
                _end:;
              ]]>
            </v:before-data-bind>

            <div class="new-form-header">
              <div style="float: left; padding-top: 3px;">
                <v:label format="%s" value="--initcap(self.abAction) || case when (self.abAction = 'view') then case when (self.v_kind = 1) then ' Organization' else ' Person' end else ' Contact' end" />
              </div>
              <vm:if test="self.abAction <> 'view'">
                <div style="float: right;">
                  Type: 
                  <v:select-list name="ab_kind" xhtml_id="ab_kind" xhtml_onchange="javascript: changeType(this);">
                    <v:item value="0" name="Person" />
                    <v:item value="1" name="Organization" />
                    <v:before-data-bind>
                    <![CDATA[
                      control.ufl_value := self.v_kind;
                      control.vc_data_bound := 1;
                    ]]>
                  </v:before-data-bind>
                </v:select-list>
                </div>
              </vm:if>
              <vm:if test="self.abAction = 'view'">
                <?vsp http (sprintf ('<input type="hidden" name="ab_kind" id="ab_kind" value="%d" />', self.v_kind)); ?>
              </vm:if>
              <br style="clear: both;" />
            </div>
            <v:text name="tabNo" xhtml_id="tabNo" type="hidden" value="--self.v_tabNo"/>
            <v:text name="dirty_force_global" xhtml_id="dirty_force_global" type="hidden" value="--get_keyword ('dirty_force_global', self.vc_event.ve_params, 'false')"/>
            <div id="a" class="c1">
              <div class="tabs">
                &nbsp;<vm:tabCaption tab="a" tabsCount="4" tabNo="0" caption="Main" />
                &nbsp;<vm:tabCaption tab="a" tabsCount="4" tabNo="1" caption="Contact" />
                &nbsp;<vm:tabCaption tab="a" tabsCount="4" tabNo="2" caption="Home" />
                &nbsp;<vm:tabCaption tab="a" tabsCount="4" tabNo="3" caption="Business" />
              </div>
              <div class="contents">
                <div id="a_content_0" class="tabContent" style="display: none;">
                  <table class="form-body" cellspacing="0">
                    <tr>
                        <th>
                          <v:label for="ab_iri" value="Contact URI" />
                        </th>
                        <td>
                          <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_iri" value="--self.v_iri" fmt-function="AB.WA.utf2wide" xhtml_onblur="javascript: AB.getFOAFData(this.value);" xhtml_size="60" />
                          </vm:if>
                          <?vsp self.viewField (self.v_iri); ?>
                        </td>
                      </tr>
                      <tr>
                      <th width="25%">
                        <v:label for="ab_name" value="Name (*)" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_name" value="--self.v_name" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_name); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_title" value="Title"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:select-list name="ab_title">
                          <v:item name="" value=""/>
                          <v:item name="Mr" value="Mr"/>
                          <v:item name="Mrs" value="Mrs"/>
                          <v:item name="Ms" value="Ms"/>
                          <v:item name="Dr" value="Dr"/>
                            <v:item name="Sir" value="Sir" />
                          <v:before-data-bind>
                            <![CDATA[
                              control.ufl_value := self.v_title;
                              control.vc_data_bound := 1;
                            ]]>
                          </v:before-data-bind>
                        </v:select-list>
                        </vm:if>
                        <?vsp self.viewField (self.v_title); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_fName" value="First Name"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_fName" value="--self.v_fName" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_fName); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_mName" value="Middle Name" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_mName" value="--self.v_mName" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_mName); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_lName" value="Last Name"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_lName" value="--self.v_lName" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_lName); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_fullName" value="Full Name"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_fullName" value="--self.v_fullName" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_fullName); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_gender" value="Gender" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:select-list name="ab_gender">
                          <v:item name="" value=""/>
                          <v:item name="Male" value="male"/>
                          <v:item name="Female" value="female"/>
                          <v:before-data-bind>
                            <![CDATA[
                              control.ufl_value := self.v_gender;
                              control.vc_data_bound := 1;
                            ]]>
                          </v:before-data-bind>
                        </v:select-list>
                        </vm:if>
                        <?vsp self.viewField (self.v_gender); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="regbday" value="Birthday" />
                      </th>
                      <td nowrap="1">
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_birthday" xhtml_id="ab_birthday" null-value="--''" value="--AB.WA.dt_format (self.v_birthday, 'Y-M-D')" xhtml_onclick="javascript: cPopup.select ($(\'ab_birthday\'), \'ab_birthday_select\', \'yyyy-MM-dd\');" xhtml_class="textbox" xhtml_size="10" />
                            <a href="#" name="ab_birthday_select" id="ab_birthday_select" onclick="cPopup.select ($('ab_birthday'), 'ab_birthday_select', 'yyyy-MM-dd'); return false;" class="noapp">
                            <img border="0" title="pick" alt="pick" src="image/pick_calendar.gif" />
                          </a>
                        </vm:if>
                        <?vsp self.viewField (self.v_birthday); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_foaf" value="FOAF file URL" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:text name="ab_foaf" value="--self.v_foaf" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_foaf); ?>
                      </td>
                    </tr>
                    <vm:if test="self.abAction <> 'view'">
                      <tr>
                        <th>
                          <v:label for="ab_grants" value="Share with" />
                        </th>
                        <td>
                          <v:text name="ab_grants" null-value="--''" value="--self.v_grants" xhtml_class="textbox" xhtml_size="60" xhtml_title="User names must be comma delimited!" />
                          <input type="button" value="Select" onclick="javascript: windowShow('users.vspx?mode=u&dst=m&amp;params=ab_grants:s1;',520)" class="button" />
                          <input type="button" value="Clear" onclick="javascript: document.F1.elements['ab_grants'].value = ''" class="button" />
                        </td>
                      </tr>
                    </vm:if>
                    <tr>
                        <th>
                          <v:label for="ab_category" value="Category" />
                        </th>
                        <td id="td_cc">
                          <vm:if test="self.abAction <> 'view'">
                            <![CDATA[
                              <script type="text/javascript">
                                function categoryCombo ()
                                {
                                  var cc = new OAT.Combolist([], "<?V coalesce (self.v_category_name, '') ?>");
                                  cc.input.name = "ab_category_name";
                                  cc.input.id = "ab_category_name";
                                  cc.input.size = "60";
                                  $("td_cc").appendChild(cc.div);
                                  cc.addOption("");
                                  <?vsp
                                    for (select C_NAME from AB.WA.CATEGORIES where C_DOMAIN_ID = self.domain_id order by C_NAME) do
                                    {
                                      http (sprintf ('cc.addOption("%s");', C_NAME));
                                    }
                                  ?>
                                }
                                OAT.MSG.attach(OAT, OAT.MSG.OAT_LOAD, categoryCombo);
                               </script>
                            ]]>
                          </vm:if>
                          <?vsp self.viewField (self.v_category_name); ?>
                        </td>
                      </tr>
                      <tr>
                      <script type="text/javascript">
                        function suggestTags ()
                        {
                          window.open ('tags.vspx?sid=<?V self.sid ?>&amp;realm=<?V self.realm ?>&amp;txt=' + escape (document.F1.elements['ab_name'].value) + '&amp;fld=ab_tags', 'bookmarks_suggest_window', 'top=100, left=100, scrollbars=yes, resize=yes, menubar=no, height=420, width=500');
                        }
                      </script>
                      <th>
                        <v:label for="ab_tags" value="Tags (comma-separated)" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                        <v:text name="ab_tags" null-value="''" value="--self.v_tags" xhtml_class="textbox" xhtml_size="60"/>
                          <input type="button" value="Suggest" onclick="javascript: suggestTags();" class="button" />
                          <input type="button" value="Clear" onclick="javascript: document.F1.elements['ab_tags'].value = ''" class="button" />
                        </vm:if>
                          <?vsp self.viewTags (self.v_tags); ?>
                      </td>
                    </tr>
                    <vm:if test="self.abAction <> 'view'">
                        <?vsp self.myTags ('ab_tags'); ?>
                    </vm:if>
                  </table>
                </div>
                <div id="a_content_1" class="tabContent" style="display: none;">
                  <table class="form-body" cellspacing="0">
                    <tr>
                      <th width="25%">
                        <v:label for="ab_mail" value="Mail"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_mail" value="--self.v_mail" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_mail); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_web" value="Web"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_web" value="--self.v_web" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_web); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_icq" value="Icq"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_icq" value="--self.v_icq" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_icq); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_skype" value="Skype ID"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_skype" value="--self.v_skype" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_skype); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_aim" value="AIM Name"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_aim" value="--self.v_aim" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_aim); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_yahoo" value="Yahoo! ID"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_yahoo" value="--self.v_yahoo" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_yahoo); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_msn" value="MSN Messenger"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_msn" value="--self.v_msn" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_msn); ?>
                      </td>
                    </tr>
                  </table>
                </div>
                <div id="a_content_2" class="tabContent" style="display: none;">
                  <table class="form-body" cellspacing="0">
                    <tr>
                      <th width="25%">
                        <v:label for="ab_hCountry" value="Country"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:data-list name="ab_hCountry" xhtml_id="ab_hCountry" sql="select '' as WC_NAME from WA_COUNTRY union select WC_NAME from WA_COUNTRY" key-column="WC_NAME" value-column="WC_NAME" xhtml_onchange="javascript: updateState(\'ab_hCountry\', \'ab_hState\');" >
                   		    <v:after-data-bind>
      		                  <![CDATA[
                                  if (e.ve_initiator = control)
                                  {
                    		        control.ufl_value := get_keyword (control.vc_get_name(), e.ve_params);
                          			self.v_hState := null;
                         			  self.ab_hState.vc_data_bind (e);
                          		} else {
      		                      control.ufl_value := self.v_hCountry;
                          		}
                                  if (is_empty_or_null (self.v_hLat) and is_empty_or_null (self.v_hLng) and (not e.ve_is_post or e.ve_initiator = control))
                                  {
      		                      whenever not found goto _end;
      		                      select WC_LAT, WC_LNG into self.v_hLat, self.v_hLng from WA_COUNTRY where WC_NAME = control.ufl_value;
      		                    _end:;
      		                    }
      		                    control.vs_set_selected ();
      		                  ]]>
      		                </v:after-data-bind>
                        </v:data-list>
                        </vm:if>
                        <?vsp self.viewField (self.v_hCountry); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                          <v:label for="ab_hState" value="State/Province" />
                      </th>
      		            <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:data-list name="ab_hState" xhtml_id="ab_hState" value="--self.v_hState" sql="select * from WA_PROVINCE where WP_COUNTRY = self.ab_hCountry.ufl_value" key-column="WP_PROVINCE" value-column="WP_PROVINCE" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hState); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hCity" value="City/Town"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hCity" value="--self.v_hCity" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hCity); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hCode" value="Zip/Postal Code" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                        <v:text name="ab_hCode" value="--self.v_hCode" xhtml_size="20" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hCode); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hAddress1" value="Address1"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hAddress1" value="--self.v_hAddress1" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hAddress1); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hAddress2" value="Address2"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hAddress2" value="--self.v_hAddress2" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hAddress2); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hTzone" value="Time Zone"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                        <v:select-list name="ab_hTzone">
                          <v:on-init>
                            <![CDATA[
                              declare i,j int;
                              declare x,y any;

                              x := make_array (25, 'any');
                              y := make_array (25, 'any');
                              i := -12;
                              j := 0;
                              while (i <= 12) {
                                x[j] := cast (i as varchar);
                                  y[j] := self.viewTimeZone (i);
                                i := i + 1;
                                j := j + 1;
                              }
                              control.vsl_item_values := x;
                              control.vsl_items := y;
                              control.ufl_value := '0';
                            ]]>
                          </v:on-init>
                          <v:before-data-bind>
                              control.ufl_value := coalesce (self.v_hTzone, '0');
                          </v:before-data-bind>
                        </v:select-list>
                        </vm:if>
                        <?vsp self.viewField (self.viewTimeZone (self.v_hTzone)); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hLat" value="Latitude"/>
                      </th>
		                  <td>
                        <vm:if test="self.abAction <> 'view'">
			                  <v:text name="ab_hLat" value="--case when self.v_hLat is not null then sprintf ('%.6f', coalesce (self.v_hLat, 0.00)) else '' end" xhtml_size="20" />
                  			<v:button action="simple" value="Set from address">
                  			  <v:on-post>
                  			    <![CDATA[
                  			      declare lat, lng double precision;

                  			      if (0 <> DB.DBA.WA_MAPS_ADDR_TO_COORDS (
                            		        trim (coalesce (self.ab_hAddress1.ufl_value, '')),
                            		        trim (coalesce (self.ab_hAddress2.ufl_value, '')),
                            		        trim (coalesce (self.ab_hCity.ufl_value, '')),
                            		        trim (coalesce (self.ab_hState.ufl_value, '')),
                            		        trim (coalesce (self.ab_hCode.ufl_value, '')),
                            		        trim (coalesce (self.ab_hCountry.ufl_value, '')),
                            		        lat,
                            		        lng)
                  			        )
                  			      {
                  			        self.ab_hLat.ufl_value := lat;
                  			        self.ab_hLng.ufl_value := lng;
                  			      }
                  			    ]]>
           		            </v:on-post>
			                  </v:button>
                        </vm:if>
                        <?vsp self.viewField (cast (self.v_hLat as varchar)); ?>
		                  </td>
		                </tr>
		                <tr>
                      <th>
                        <v:label for="ab_hLng" value="Longitude" />
                      </th>
		                  <td>
                        <vm:if test="self.abAction <> 'view'">
			                  <v:text name="ab_hLng" value="--case when self.v_hLng is not null then sprintf ('%.6f', coalesce (self.v_hLng, 0.00)) else '' end" xhtml_size="20" />
                        </vm:if>
                        <?vsp self.viewField (cast (self.v_hLng as varchar)); ?>
		                  </td>
		                </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hWeb" value="Web"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hWeb" value="--self.v_hWeb" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hWeb); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hMail" value="Mail"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hMail" value="--self.v_hMail" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hMail); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hPhone" value="Phone"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hPhone" value="--self.v_hPhone" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hPhone); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hMobile" value="Mobile"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hMobile" value="--self.v_hMobile" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hMobile); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_hFax" value="Fax" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_hFax" value="--self.v_hFax" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_hFax); ?>
                      </td>
                    </tr>
                  </table>
                </div>
                <div id="a_content_3" class="tabContent" style="display: none;">
                  <table class="form-body" cellspacing="0">
                    <tr>
                      <th width="25%">
                        <v:label for="ab_bCountry" value="Country"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:data-list name="ab_bCountry" xhtml_id="ab_bCountry" sql="select '' as WC_NAME from WA_COUNTRY union select WC_NAME from WA_COUNTRY" key-column="WC_NAME" value-column="WC_NAME" xhtml_onchange="javascript: updateState(\'ab_bCountry\', \'ab_bState\');" >
                   		    <v:after-data-bind>
      		                  <![CDATA[
      		                    if (e.ve_initiator = control) {
                    		        control.ufl_value := get_keyword (control.vc_get_name(), e.ve_params);
                                  self.v_bState := null;
                                   self.ab_bState.vc_data_bind (e);
                          		} else {
      		                      control.ufl_value := self.v_bCountry;
                          		}
      		                    if (self.v_bLat is null and self.v_bLng is null and (not e.ve_is_post or e.ve_initiator = control)) {
      		                      whenever not found goto _end;
      		                      select WC_LAT, WC_LNG into self.v_bLat, self.v_bLng from WA_COUNTRY where WC_NAME = control.ufl_value;
      		                    _end:;
      		                    }
      		                    control.vs_set_selected ();
      		                  ]]>
      		                </v:after-data-bind>
                        </v:data-list>
                        </vm:if>
                        <?vsp self.viewField (self.v_bCountry); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_skype" value="State/Province"/>
                      </th>
      		            <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:data-list name="ab_bState" xhtml_id="ab_bState" value="--self.v_bState" sql="select * from WA_PROVINCE where WP_COUNTRY = self.ab_bCountry.ufl_value" key-column="WP_PROVINCE" value-column="WP_PROVINCE" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bState); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bCity" value="City/Town"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bCity" value="--self.v_bCity" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bCity); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bCode" value="Zip/Postal Code"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                        <v:text name="ab_bCode" value="--self.v_bCode" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bCode); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bAddress1" value="Address1"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bAddress1" value="--self.v_bAddress1" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bAddress1); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bAddress2" value="Address2"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bAddress2" value="--self.v_bAddress2" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bAddress2); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bTzone" value="Time Zone"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                        <v:select-list name="ab_bTzone">
                          <v:on-init>
                            <![CDATA[
                              declare i,j int;
                              declare x,y any;

                              x := make_array (25, 'any');
                              y := make_array (25, 'any');
                              i := -12;
                              j := 0;
                              while (i <= 12) {
                                x[j] := cast (i as varchar);
                                  y[j] := self.viewTimeZone (i);
                                i := i + 1;
                                j := j + 1;
                              }
                              control.vsl_item_values := x;
                              control.vsl_items := y;
                              control.ufl_value := '0';
                            ]]>
                          </v:on-init>
                          <v:before-data-bind>
                              control.ufl_value := coalesce (self.v_bTzone, '0');
                          </v:before-data-bind>
                        </v:select-list>
                        </vm:if>
                        <?vsp self.viewField (self.viewTimeZone (self.v_bTzone)); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bLat" value="Latitude"/>
                      </th>
		                  <td>
                        <vm:if test="self.abAction <> 'view'">
			                  <v:text name="ab_bLat" value="--case when self.v_bLat is not null then sprintf ('%.6f', coalesce (self.v_bLat, 0.00)) else '' end" xhtml_size="20" />
                  			<v:button action="simple" value="Set from address">
                  			  <v:on-post>
                  			    <![CDATA[
                  			      declare lat, lng double precision;

                  			      if (0 <> DB.DBA.WA_MAPS_ADDR_TO_COORDS
                  			               (
                            		         trim (coalesce (self.ab_bAddress1.ufl_value, '')),
                            		         trim (coalesce (self.ab_bAddress2.ufl_value, '')),
                            		         trim (coalesce (self.ab_bCity.ufl_value, '')),
                                           trim (coalesce (self.ab_bState.ufl_value, '')),
                            		         trim (coalesce (self.ab_bCode.ufl_value, '')),
                            		         trim (coalesce (self.ab_bCountry.ufl_value, '')),
                            		         lat,
                            		         lng
                            		       )
                  			        )
                  			      {
                  			        self.ab_bLat.ufl_value := lat;
                  			        self.ab_bLng.ufl_value := lng;
                  			      }
                  			    ]]>
           		            </v:on-post>
			                  </v:button>
                        </vm:if>
                        <?vsp self.viewField (cast (self.v_bLat as varchar)); ?>
		                  </td>
		                </tr>
		                <tr>
                      <th>
                        <v:label for="ab_bLng" value="Longitude" />
                      </th>
		                  <td>
                        <vm:if test="self.abAction <> 'view'">
			                  <v:text name="ab_bLng" value="--case when self.v_bLng is not null then sprintf ('%.6f', coalesce (self.v_bLng, 0.00)) else '' end" xhtml_size="20" />
                        </vm:if>
                        <?vsp self.viewField (cast (self.v_bLng as varchar)); ?>
		                  </td>
		                </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bIndustry" value="Industry"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                          <v:data-list name="ab_bIndustry" sql="select '' as WI_NAME from WA_INDUSTRY union select WI_NAME from WA_INDUSTRY" key-column="WI_NAME" value-column="WI_NAME">
		                      <v:before-data-bind>
			                      control.ufl_value := self.v_bIndustry;
		                      </v:before-data-bind>
		                    </v:data-list>
                        </vm:if>
                        <?vsp self.viewField (self.v_bIndustry); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_bOrganization" value="Organization"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bOrganization" value="--self.v_bOrganization" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bOrganization); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_bDepartment" value="Department" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bDepartment" value="--self.v_bDepartment" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bDepartment); ?>
                      </td>
                    </tr>
                    <tr class="contactType">
                      <th>
                        <v:label for="ab_bJob" value="Job Title"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bJob" value="--self.v_bJob" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bJob); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bWeb" value="Web"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bWeb" value="--self.v_bWeb" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bWeb); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bMail" value="Mail"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bMail" value="--self.v_bMail" fmt-function="AB.WA.utf2wide" xhtml_size="60" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bMail); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bPhone" value="Phone"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bPhone" value="--self.v_bPhone" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bPhone); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bMobile" value="Mobile"/>
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bMobile" value="--self.v_bMobile" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bMobile); ?>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="ab_bFax" value="Fax" />
                      </th>
                      <td>
                        <vm:if test="self.abAction <> 'view'">
                            <v:text name="ab_bFax" value="--self.v_bFax" fmt-function="AB.WA.utf2wide" xhtml_size="30" />
                        </vm:if>
                        <?vsp self.viewField (self.v_bFax); ?>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
            <div class="new-form-footer">
                <v:button action="simple" name="ab_save" value="Save" enabled="--case when (self.abAction <> 'view') then 1 else 0 end" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    declare tmp any;

                    declare exit handler for SQLSTATE '*' {
                      if (__SQL_STATE = 'TEST') {
                        self.vc_error_message := AB.WA.test_clear (__SQL_MESSAGE);
                        self.vc_is_valid := 0;
                        return;
                      }
                      resignal;
                    };

                    self.v_kind := cast (self.ab_kind.ufl_value as integer);
                    self.v_name := AB.WA.test (self.ab_name.ufl_value, vector('name', 'Name', 'class', 'varchar', 'type', 'varchar', 'minLength', 1, 'maxLength', 255));
                    self.v_tags := trim (self.ab_tags.ufl_value);
                    AB.WA.test (self.v_tags, vector ('name', 'Tags', 'class', 'tags'));
                    tmp := AB.WA.tags2vector (self.v_tags);
                    tmp := AB.WA.vector_unique (tmp);
                    self.v_tags := AB.WA.vector2tags (tmp);

                    declare dt datetime;

  	                dt := null;
                      if (not self.v_kind)
                      {
                        if (not is_empty_or_null (self.ab_birthday.ufl_value))
                        {
                          declare exit handler for sqlstate '*'
                          {
                          self.vc_error_message := sprintf ('An invalid birth date (%s) is specified', self.ab_birthday.ufl_value);
			                  self.vc_is_valid := 0;
           			        return;
			                };
                      dt := stringdate (self.ab_birthday.ufl_value);
			              }
                    }

                		self.v_hLat := null;
                		self.v_hLng := null;
                      if (not self.v_kind)
                      {
                        if (length (self.ab_hLat.ufl_value) and length (self.ab_hLng.ufl_value))
                        {
          			      self.v_hLat := atof (self.ab_hLat.ufl_value);
          			      self.v_hLng := atof (self.ab_hLng.ufl_value);
			              }
                    }
                		self.v_bLat := null;
                		self.v_bLng := null;
                      if (length (self.ab_bLat.ufl_value) and length (self.ab_bLng.ufl_value))
                      {
          			      self.v_bLat := atof (self.ab_bLat.ufl_value);
          			      self.v_bLng := atof (self.ab_bLng.ufl_value);
			              }
                    self.v_title         := trim (self.ab_title.ufl_value);
                    self.v_fName         := case when self.v_kind then '' else trim (self.ab_fName.ufl_value) end;
                    self.v_mName         := case when self.v_kind then '' else trim (self.ab_mName.ufl_value) end;
                    self.v_lName         := case when self.v_kind then '' else trim (self.ab_lName.ufl_value) end;
                    self.v_fullName      := trim (self.ab_fullName.ufl_value);
                    self.v_gender        := case when self.v_kind then '' else trim (self.ab_gender.ufl_value) end;
                    self.v_birthday      := dt;
                    self.v_iri           := trim (self.ab_iri.ufl_value);
                    self.v_foaf          := trim (self.ab_foaf.ufl_value);
                    self.v_mail          := case when self.v_kind then '' else trim (self.ab_mail.ufl_value) end;
                    self.v_web           := case when self.v_kind then '' else trim (self.ab_web.ufl_value) end;
                    self.v_icq           := case when self.v_kind then '' else trim (self.ab_icq.ufl_value) end;
                    self.v_skype         := case when self.v_kind then '' else trim (self.ab_skype.ufl_value) end;
                    self.v_aim           := case when self.v_kind then '' else trim (self.ab_aim.ufl_value) end;
                    self.v_yahoo         := case when self.v_kind then '' else trim (self.ab_yahoo.ufl_value) end;
                    self.v_msn           := case when self.v_kind then '' else trim (self.ab_msn.ufl_value) end;
                    self.v_hCountry      := case when self.v_kind then '' else trim (self.ab_hCountry.ufl_value) end;
                    self.v_hCity         := case when self.v_kind then '' else trim (self.ab_hCity.ufl_value) end;
                    self.v_hState        := case when self.v_kind then '' else trim (self.ab_hState.ufl_value) end;
                    self.v_hCode         := case when self.v_kind then '' else trim (self.ab_hCode.ufl_value) end;
                    self.v_hAddress1     := case when self.v_kind then '' else trim (self.ab_hAddress1.ufl_value) end;
                    self.v_hAddress2     := case when self.v_kind then '' else trim (self.ab_hAddress2.ufl_value) end;
                    self.v_hTzone        := case when self.v_kind then '' else trim (self.ab_hTzone.ufl_value) end;
                    self.v_hPhone        := case when self.v_kind then '' else trim (self.ab_hPhone.ufl_value) end;
                    self.v_hMobile       := case when self.v_kind then '' else trim (self.ab_hMobile.ufl_value) end;
                    self.v_hFax          := case when self.v_kind then '' else trim (self.ab_hFax.ufl_value) end;
                    self.v_hMail         := case when self.v_kind then '' else trim (self.ab_hMail.ufl_value) end;
                    self.v_hWeb          := case when self.v_kind then '' else trim (self.ab_hWeb.ufl_value) end;
                    self.v_bCountry      := trim (self.ab_bCountry.ufl_value);
                    self.v_bCity         := trim (self.ab_bCity.ufl_value);
                    self.v_bState        := trim (self.ab_bState.ufl_value);
                    self.v_bCode         := trim (self.ab_bCode.ufl_value);
                    self.v_bAddress1     := trim (self.ab_bAddress1.ufl_value);
                    self.v_bAddress2     := trim (self.ab_bAddress2.ufl_value);
                    self.v_bTzone        := trim (self.ab_bTzone.ufl_value);
                    self.v_bPhone        := trim (self.ab_bPhone.ufl_value);
                    self.v_bMobile       := trim (self.ab_bMobile.ufl_value);
                    self.v_bFax          := trim (self.ab_bFax.ufl_value);
                    self.v_bIndustry     := trim (self.ab_bIndustry.ufl_value);
                    self.v_bOrganization := trim (self.ab_bOrganization.ufl_value);
                    self.v_bDepartment   := trim (self.ab_bDepartment.ufl_value);
                    self.v_bJob          := trim (self.ab_bJob.ufl_value);
                    self.v_bMail         := trim (self.ab_bMail.ufl_value);
                    self.v_bWeb          := trim (self.ab_bWeb.ufl_value);

                      self.v_category_id   := AB.WA.category_update (self.domain_id, get_keyword ('ab_category_name', e.ve_params));

                      self.v_id := AB.WA.contact_update
                      (
                      self.v_id,
                      self.domain_id,
                        self.v_category_id,
                      self.v_kind,
                      self.v_name,
                      self.v_title,
                      self.v_fName,
                      self.v_mName,
                      self.v_lName,
                      self.v_fullName,
                      self.v_gender,
                      self.v_birthday,
                      self.v_iri,
                      self.v_foaf,
                      self.v_mail,
                      self.v_web,
                      self.v_icq,
                      self.v_skype,
                      self.v_aim,
                      self.v_yahoo,
                      self.v_msn,
                      self.v_hCountry,
                      self.v_hState,
                      self.v_hCity,
                      self.v_hCode,
                      self.v_hAddress1,
                      self.v_hAddress2,
                      self.v_hTzone,
                      self.v_hLat,
                      self.v_hLng,
                      self.v_hPhone,
                      self.v_hMobile,
                      self.v_hFax,
                      self.v_hMail,
                      self.v_hWeb,
                      self.v_bCountry,
                      self.v_bState,
                      self.v_bCity,
                      self.v_bCode,
                      self.v_bAddress1,
                      self.v_bAddress2,
                      self.v_bTzone,
                      self.v_bLat,
                      self.v_bLng,
                      self.v_bPhone,
                      self.v_bMobile,
                      self.v_bFax,
                      self.v_bIndustry,
                      self.v_bOrganization,
                      self.v_bDepartment,
                      self.v_bJob,
                      self.v_bMail,
                      self.v_bWeb,
                      self.v_tags
                    );
                    self.v_grants := trim (self.ab_grants.ufl_value);
                    self.shareNode (self.v_id, self.v_grants, 1);

                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
              <v:button action="simple" name="ab_cancel" value="Cancel" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
            </div>
            <script>
              <![CDATA[
                changeType($('ab_kind'));
              ]]>
            </script>
          </v:template>

          <v:template type="simple" enabled="--case when (self.abAction = 'import') then 1 else 0 end">

            <v:template type="simple" enabled="-- case when (self.abStep = '1') then 1 else 0 end">
	            <div class="new-form-header">
	              <v:label format="%s" value="Import: Select source type"/>
	            </div>

	            <div class="new-form-body">
	              <table cellspacing="0">
	                <tr>
                    <th rowspan="4" valign="middle" width="45%">
	                    <v:label for="i_file" value="Source type"/>
	                  </th>
	                  <td nowrap="nowarap">
	                    <v:radio-button name="i_source_0" xhtml_id="i_source_0" group-name="i_source" value="0">
	                      <v:before-render>
	                        <![CDATA[
	                          control.ufl_selected := either(lte(self.i_source, 0), 1, 0);
	                        ]]>
	                      </v:before-render>
	                    </v:radio-button>
	                    <xsl:call-template name="nbsp"/>
	                    <b><vm:label for="i_source_0" value="--'File'" /></b>
	                  </td>
	                </tr>
	                <tr>
	                  <td nowrap="nowarap">
	                    <v:radio-button name="i_source_1" xhtml_id="i_source_1" group-name="i_source" value="1">
	                      <v:before-render>
	                        <![CDATA[
	                          control.ufl_selected := either(equ(self.i_source, 1), 1, 0);
	                        ]]>
	                      </v:before-render>
	                    </v:radio-button>
	                    <xsl:call-template name="nbsp"/>
	                    <b><vm:label for="i_source_1" value="--'WebDAV'" /></b>
	                  </td>
	                </tr>
	                <tr>
	                  <td nowrap="nowarap">
	                    <v:radio-button name="i_source_2" xhtml_id="i_source_2" group-name="i_source" value="2">
	                      <v:before-render>
	                        <![CDATA[
	                          control.ufl_selected := either(equ(self.i_source, 2), 1, 0);
	                        ]]>
	                      </v:before-render>
	                    </v:radio-button>
	                    <xsl:call-template name="nbsp"/>
                        <b><vm:label for="i_source_2" value="--'URI'" /></b>
                    </td>
                  </tr>
                  <tr>
                    <td nowrap="nowarap">
                      <v:radio-button name="i_source_3" xhtml_id="i_source_3" group-name="i_source" value="3">
                        <v:before-render>
                          <![CDATA[
                            control.ufl_selected := either(equ(self.i_source, 3), 1, 0);
                          ]]>
                        </v:before-render>
                      </v:radio-button>
                      <xsl:call-template name="nbsp" />
                      <b><vm:label for="i_source_3" value="--'LDAP Server'" /></b>
	                  </td>
	                </tr>
	              </table>
	            </div>

	            <div class="new-form-footer">
                  <v:button action="simple" name="i1_next" value="Next" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    declare tmp any;

                      self.abStep := '2';
	                    tmp := self.i_source;
                        if (self.i_source_0.ufl_selected)
                        {
	                      self.i_source := 0;
                        }
                        else if (self.i_source_1.ufl_selected)
                        {
	                      self.i_source := 1;
                        }
                        else if (self.i_source_2.ufl_selected)
                        {
	                      self.i_source := 2;
                        }
                        else if (self.i_source_3.ufl_selected)
                        {
                        self.i_source := 3;
	                      self.i_type := 3;
                        self.abStep := '3';
	                    }

                      AB.WA.push (self.abSteps, '1');
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
                <v:button action="simple" name="i1_cancel" value="Cancel" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    self.abAction := 'browse';
	                    self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
	            </div>
	          </v:template>

            <v:template type="simple" enabled="-- case when (self.abStep = '2') then 1 else 0 end">
	            <div class="new-form-header">
	              <v:label format="%s" value="Import: Select content type"/>
	            </div>

	            <div class="new-form-body">
	              <table cellspacing="0">
	                <tr>
	                  <th rowspan="3" valign="middle" width="45%">
	                    <v:label for="i_file" value="Content type"/>
	                  </th>
	                  <td nowrap="nowarap">
	                    <v:radio-button name="i_type_0" xhtml_id="i_type_0" group-name="i_type" value="0">
	                      <v:before-render>
	                        <![CDATA[
	                          control.ufl_selected := either(lte(self.i_type, 0), 1, 0);
	                        ]]>
	                      </v:before-render>
	                    </v:radio-button>
	                    <xsl:call-template name="nbsp"/>
	                    <b><vm:label for="i_type_0" value="--'vCard'" /></b>
	                  </td>
	                </tr>
	                <tr>
	                  <td nowrap="nowarap">
	                    <v:radio-button name="i_type_1" xhtml_id="i_type_1" group-name="i_type" value="1">
	                      <v:before-render>
	                        <![CDATA[
	                          control.ufl_selected := either(equ(self.i_type, 1), 1, 0);
	                        ]]>
	                      </v:before-render>
	                    </v:radio-button>
	                    <xsl:call-template name="nbsp"/>
	                    <b><vm:label for="i_type_1" value="--'FOAF'" /></b>
	                  </td>
	                </tr>
	                <tr>
	                  <td nowrap="nowarap">
	                    <v:radio-button name="i_type_2" xhtml_id="i_type_2" group-name="i_type" value="2">
	                      <v:before-render>
	                        <![CDATA[
	                          control.ufl_selected := either(equ(self.i_type, 2), 1, 0);
	                        ]]>
	                      </v:before-render>
	                    </v:radio-button>
	                    <xsl:call-template name="nbsp"/>
	                    <b><vm:label for="i_type_2" value="--'CSV'" /></b>
	                  </td>
	                </tr>
	              </table>
	            </div>

	            <div class="new-form-footer">
                  <v:button action="simple" name="i2_back" value="Back" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
                      self.abStep := AB.WA.pop (self.abSteps);
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
                  <v:button action="simple" name="i2_next" value="Next" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    if (self.i_type_0.ufl_selected) {
	                      self.i_type := 0;
                        }
                        else if (self.i_type_1.ufl_selected)
                        {
	                      self.i_type := 1;
                        }
                        else if (self.i_type_2.ufl_selected)
                        {
	                      self.i_type := 2;
	                    }

                      self.abStep := '3';
                      AB.WA.push (self.abSteps, '2');
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
                <v:button action="simple" name="i2_cancel" value="Cancel" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    self.abAction := 'browse';
                      self.resetImport ();
	                    self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
	            </div>
	          </v:template>

            <v:template type="simple" enabled="-- case when (self.abStep = '3') then 1 else 0 end">
	            <div class="new-form-header">
	              <v:label format="%s" value="Import: Source parameters"/>
	            </div>

	            <div class="new-form-body">
	              <table cellspacing="0">
                  <vm:if test="self.i_source = 0">
		                <tr>
		                  <th width="30%">
                        Select file
		                  </th>
		                  <td>
                        <input type="file" name="f_file" size="40"/>
		                  </td>
		                </tr>
                  </vm:if>
                  <vm:if test="self.i_source = 1">
		                <tr>
		                  <th width="30%">
	                      Select WebDAV file
		                  </th>
		                  <td>
                        <v:text name="f_dav" xhtml_id="f_dav" value="" xhtml_size="40" />
                        <v:button action="browse" value="Browse...">
                       	  <v:after-data-bind>
                       		  <![CDATA[
                              control.vc_add_attribute ('onclick', 'javascript: davBrowse (''f_dav'');');
                  			    ]]>
                  			  </v:after-data-bind>
                  		  </v:button>
		                  </td>
		                </tr>
                  </vm:if>
                  <vm:if test="self.i_source = 2">
                    <tr>
		                  <th width="30%">
                          Select URI
                      </th>
                      <td>
                        <v:text name="f_uri" value="--''" xhtml_size="60" />
                      </td>
                    </tr>
                      <vm:if test="self.i_type = 1">
                        <tr>
                          <th>
                            Grab Depth
                          </th>
                          <td>
                            <v:select-list name="i_depth">
                              <v:item value="0" name="0" />
                              <v:item value="1" name="1" />
                              <v:item value="2" name="2" />
                              <v:before-data-bind>
                                <![CDATA[
                                  control.ufl_value := self.i_contentDepth;
                                  control.vc_data_bound := 1;
                                ]]>
                              </v:before-data-bind>
                            </v:select-list>
                          </td>
                        </tr>
                        <tr>
                          <th>
                            Maximum Entity Count
                          </th>
                          <td>
                            <v:text name="i_limit" value="--self.i_contentLimit" xhtml_size="3" />
                          </td>
                        </tr>
                        <tr>
                          <th>
                            Follow Property
                          </th>
                          <td>
                            <v:select-list name="i_follow">
                              <v:item value="http://xmlns.com/foaf/0.1/knows" name="foaf:knows" />
                              <v:item value="http://www.w3.org/2002/07/owl#sameAs" name="owl:sameAs" />
                              <v:item value="http://www.w3.org/2000/01/rdf-schema#seeAlso" name="rdfs:seeAlso" />
                              <v:item value="http://www.w3.org/2000/01/rdf-schema#isDefineBy" name="rdfs:isDefineBy" />
                              <v:before-data-bind>
                                <![CDATA[
                                  control.ufl_value := self.i_contentFollow;
                                  control.vc_data_bound := 1;
                                ]]>
                              </v:before-data-bind>
                            </v:select-list>
                          </td>
                        </tr>
                      </vm:if>
                  </vm:if>
                  <vm:if test="self.i_source = 3">
                    <tr>
                      <th width="30%">
                        LDAP server
                      </th>
              	      <td>
              	        <v:data-list name="f_lName"
              	                     value="--self.i_lName"
              	                     key-column="LS_NAME"
              	                     value-column="LS_NAME"
                                     sql="select '' as LS_NAME from SYS_USERS where U_ID = 0 union all select LS_NAME from LDAP..LDAP_SERVERS where LS_USER_ID = self.account_id"
              		                   auto-submit="1">
                   		    <v:after-data-bind>
      		                  <![CDATA[
                                if (e.ve_initiator = control)
                                {
                    		        self.i_lName := get_keyword (control.vc_get_name(), e.ve_params);
                    		        control.ufl_value := self.i_lName;
                                  if (self.i_lName <> '')
                                  {
                      		        select LS_HOST,
                                         LS_PORT,
                                         LS_BASE_DN,
                                         LS_BIND_DN,
                                         LS_PASSWORD,
                                         deserialize (LS_MAPS)
                      		          into self.i_lHost,
                      		               self.i_lPort,
                      		               self.i_lBase_dn,
                      		               self.i_lBind_dn,
                      		               self.i_lPassword,
                      		               self.i_lMaps
                                    from LDAP..LDAP_SERVERS
                      		         where LS_NAME = self.i_lName
                                     and LS_USER_ID = self.account_id;
                                  self.i_maps := self.i_lMaps;
                      		      }
                          		}
      		                    control.vs_set_selected ();
      		                  ]]>
      		                </v:after-data-bind>
              	        </v:data-list>
              	      </td>
              	    </tr>
                    <tr>
		                  <th width="30%">
                        Host URL
                      </th>
                      <td>
                        <v:text name="f_lHost" null-value="--''" value="" xhtml_size="70">
                   		    <v:before-render>
      		                  <![CDATA[
                  		        control.ufl_value := self.i_lHost;
      		                  ]]>
      		                </v:before-render>
                        </v:text>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Host port
                      </th>
                      <td>
                        <v:text name="f_lPort" null-value="--''" value="" xhtml_size="10">
                   		    <v:before-render>
      		                  <![CDATA[
                  		        control.ufl_value := self.i_lPort;
      		                  ]]>
      		                </v:before-render>
                        </v:text>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Base DN
                      </th>
                      <td>
                        <v:text name="f_lBase_dn" null-value="--''" value="" xhtml_size="70">
                   		    <v:before-render>
      		                  <![CDATA[
                  		        control.ufl_value := self.i_lBase_dn;
      		                  ]]>
      		                </v:before-render>
                        </v:text>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Bind DN
                      </th>
                      <td>
                        <v:text name="f_lBind_dn" null-value="--''" value="" xhtml_size="70">
                   		    <v:before-render>
      		                  <![CDATA[
                  		        control.ufl_value := self.i_lBind_dn;
      		                  ]]>
      		                </v:before-render>
                        </v:text>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Password
                      </th>
                      <td>
                        <v:text name="f_lPassword" type="password" null-value="--self.i_lPassword" value="--''" xhtml_size="30">
                   		    <v:before-render>
      		                  <![CDATA[
                  		        control.ufl_value := self.i_lPassword;
      		                  ]]>
      		                </v:before-render>
                        </v:text>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Search string
                      </th>
                      <td>
                        <v:text name="f_lSearch" null-value="--''" value="--self.i_lSearch" xhtml_size="70"/>
                      </td>
                    </tr>
                  </vm:if>
	              </table>
	            </div>

	            <div class="new-form-footer">
                <v:button action="simple" name="i3_back" value="Back" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
                      self.abStep := AB.WA.pop (self.abSteps);
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
                  <v:button action="simple" name="i3_next" value="Next" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
                        declare tmp, host varchar;

                      declare exit handler for SQLSTATE '*' {
                        if (__SQL_STATE = 'TEST') {
                          self.vc_error_message := AB.WA.test_clear(__SQL_MESSAGE);
                          self.vc_is_valid := 0;
                          return;
                        }
                        resignal;
                      };

                        if (self.i_source = 0)
                        {
	                      self.i_data := trim(get_keyword ('f_file', self.vc_page.vc_event.ve_params, ''));
                          if (is_empty_or_null (self.i_data))
                          {
	                        self.vc_error_message := 'Please select file from your local file system!';
	                        self.vc_is_valid := 0;
	                        return;
	                      }

                        }
                        else if (self.i_source = 1)
                        {
	                      self.f_dav.ufl_value := trim(self.f_dav.ufl_value);
                          tmp := http_physical_path_resolve (replace (self.f_dav.ufl_value, ' ', '%20'));
                          self.i_data := AB.WA.dav_content (AB.WA.host_url () || tmp, AB.WA.account_name (self.account_id));
                          if (isnull(self.i_data))
                          {
	                        self.vc_error_message := 'Bad import source!';
	                        self.vc_is_valid := 0;
	                        return;
	                      }

                        }
                        else if (self.i_source = 2)
                        {
                        self.f_uri.ufl_value := trim(self.f_uri.ufl_value);
                          if (is_empty_or_null (self.f_uri.ufl_value))
                          {
                          self.vc_error_message := 'Please select correct URL address!';
                          self.vc_is_valid := 0;
                          return;
                        }
                          if (self.i_type = 1)
                          {
                            AB.WA.test (self.i_limit.ufl_value, vector('name', 'Grab Limit', 'class', 'integer', 'minValue', 1, 'maxValue', 100));
                            self.i_contentDepth := atoi (self.i_depth.ufl_value);
                            self.i_contentLimit := atoi (self.i_limit.ufl_value);
                            self.i_contentFollow := self.i_follow.ufl_value;
                          }
                        self.i_data := self.f_uri.ufl_value;
                        }
                        else if (self.i_source = 3)
                        {
                        self.i_lName := trim (self.f_lName.ufl_value);
                        self.i_lHost := trim (self.f_lHost.ufl_value);
                        self.i_lPort := trim (self.f_lPort.ufl_value);
                        self.i_lBase_dn := trim (self.f_lBase_dn.ufl_value);
                        self.i_lBind_dn := trim (self.f_lBind_dn.ufl_value);
                        self.i_lPassword := trim (self.f_lPassword.ufl_value);
                        self.i_lSearch := trim (self.f_lSearch.ufl_value);
                        AB.WA.test (self.i_lHost, vector('name', 'LDAP server host', 'class', 'varchar', 'canEmpty', 0));
                        AB.WA.test (self.i_lPort, vector('name', 'LDAP server port', 'class', 'varchar', 'canEmpty', 0));
                        AB.WA.test (self.i_lBase_dn, vector('name', 'Base DN', 'class', 'varchar', 'canEmpty', 0));
                        AB.WA.test (self.i_lBind_dn, vector('name', 'Bind DN', 'class', 'varchar', 'canEmpty', 0));

                      	declare exit handler for sqlstate '*'
                      	{
                      	  self.vc_error_message := 'Unknown LDAP server. Please, check parameters!';
                      	  self.vc_is_valid := 0;
                      	  return;
                      	};
                        connection_set ('LDAP_VERSION', 2);
                      	host := 'ldap://' || self.i_lHost || ':' || self.i_lPort;
                        self.i_data := ldap_search (host, 0, self.i_lBase_dn, self.i_lSearch, self.i_lBind_dn, self.i_lPassword);
	                    }

                        if (self.i_type = 1)
                        {
                          AB.WA.ab_graph_delete (self.i_iri);
                          self.i_iri := AB.WA.ab_graph_create ();
                          self.i_Items := AB.WA.import_foaf_content (self.i_data, case when (self.i_source = 2) then 1 else 0 end, self.i_iri, self.i_contentDepth, self.i_contentLimit, self.i_contentFollow);
                      }
                        else if (self.i_type = 2)
                        {
                        self.i_data := replace (self.i_data, '\015\012', '\012');
                        self.i_data := replace (self.i_data, '\012\015', '\012');
                        self.i_data := replace (self.i_data, '\015', '\012');
                        self.i_data := replace (self.i_data, '\012 ', '');
                        self.i_data := split_and_decode (self.i_data, 0, '\0\0\n');
                      }

                      self.abStep := '5';
                      if (self.i_type = 0)
                        self.abStep := '6';
                      if (self.i_type = 1)
                        self.abStep := '4';
                      AB.WA.push (self.abSteps, '3');
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
                <v:button action="simple" name="i3_cancel" value="Cancel" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    self.abAction := 'browse';
                      self.resetImport ();
	                    self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
	            </div>
	          </v:template>

            <v:template type="simple" enabled="-- case when (self.abStep = '4') then 1 else 0 end">
	            <div class="new-form-header">
                <v:label format="%s" value="Import: Select persons" />
              </div>

              <div class="new-form-mapping">
                <?vsp
                  declare N integer;

                  if (length (self.i_Items) = 0)
                  {
                ?>
          		  No Persons
                <?vsp
                  } else {
                ?>
                  <table id="foaf" class="AB_grid" style="border-width: 0" cellspacing="0">
                  <thead class="sortHeader">
                    <tr>
                      <th class="checkbox" width="1%">
                        <input type="checkbox" name="cb_all" value="Select All" onclick="selectAllCheckboxes(this, 'cb_item')" />
                      </th>
                      <th>Name</th>
                      <th>Mail</th>
                      <th>Comment</th>
                        <th width="1%">Action</th>
                    </tr>
                  </thead>
                <?vsp
                    for (N := 0; N < length (self.i_Items); N := N + 1)
                    {
                ?>
              	  <tr class="<?V case when (self.i_Items[N][0] = 1) then 'tr_select' else '' end ?>">
              		  <td width="1%">
                      <?vsp
                        if (self.i_Items[N][0] = 0)
                          http (sprintf ('<input type="checkbox" name="cb_item" value="%s" onclick="selectCheck(this, \'cb_item\')" />', self.i_Items[N][1]));
                      ?>
              		  </td>
              		  <td>
                        <?V AB.WA.utf2wide (self.i_Items[N][2]) ?>
              		  </td>
              		  <td>
                      <?V self.i_Items[N][3] ?>
              		  </td>
              		  <td>
                      <?vsp
                          if (self.i_Items[N][0] = 1)
                          {
                          http ('FOAF Owner');
                          http (sprintf ('<input type="hidden" name="cb_item" value="%s" />', self.i_Items[N][1]));
                        }
                      ?>
              		  </td>
              		  <td>
                      <?vsp
                        if (not is_empty_or_null (self.i_Items[N][3]))
                            http (self.windowOpen (sprintf ('invite.vspx?name=%U&mail=%U', self.i_Items[N][2], self.i_Items[N][3]), 'invite', self.i_Items[N][2]));
                      ?>
              		  </td>
                  </tr>
                <?vsp
                    }
                ?>
                </table>
                <?vsp
                  }
                ?>
              </div>
              <script>
                <![CDATA[
                  coloriseTable('foaf');
                ]]>
              </script>

              <div class="new-form-footer">
                <v:button action="simple" name="i4_back" value="Back" xhtml_class="form-button">
                  <v:on-post>
                    <![CDATA[
                      self.abStep := AB.WA.pop (self.abSteps);
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                  <v:button action="simple" name="i4_next" value="Next" xhtml_class="form-button">
                  <v:on-post>
                    <![CDATA[
                      declare N integer;
                      declare params any;

                      params := e.ve_params;
                        self.i_contentItems := vector ();
                      for (N := 0; N < length (params); N := N + 4)
                      {
                        if (params[N] = 'cb_item')
                            self.i_contentItems := vector_concat (self.i_contentItems, vector (vector (params[N+1])));
                      }

                        if (length (self.i_contentItems))
                        {
                        self.abStep := '6';
                        if ((self.i_type = 2) or (self.i_type = 3))
                        {
                          self.abStep := '5';
                        }
                        AB.WA.push (self.abSteps, '4');
                      } else {
                        self.abAction := 'browse';
                        self.resetImport ();
                      }
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button action="simple" name="i4_cancel" value="Cancel" xhtml_class="form-button">
                  <v:on-post>
                    <![CDATA[
                      self.abAction := 'browse';
                      self.resetImport ();
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
              </div>
            </v:template>

            <v:template type="simple" enabled="-- case when (self.abStep = '5') then 1 else 0 end">
              <div class="new-form-header">
	              <v:label format="%s" value="Import: Mapping"/>
	            </div>
	            <div class="new-form-mapping">
              <vm:if test="self.i_type = 2">
                    <table id="ldap" class="AB_grid" style="border-width: 0" cellspacing="0">
                  <thead class="sortHeader">
                    <tr>
                      <th>CSV Column</th>
                      <th>Contact Property</th>
                    </tr>
                  </thead>
                  <tr>
                  </tr>
                  <?vsp
                    declare N, M integer;
                    declare data any;

                      self.i_Options := LDAP..contact_fields ();
                      for (N := 0; N < 1; N := N + 2)
                      {
                      data := split_and_decode (self.i_data [N], 0, '\0\0,');
                        for (M := 0; M < length (data); M := M + 1)
                        {
              	  ?>
              	  <tr>
              	    <td>
              		    <?V trim (data[M], '"') ?>
              		  </td>
              		  <td nowrap="1">
              		    <?vsp
              		      self.render_select (cast (M as varchar));
              		    ?>
              		  </td>
                  </tr>
              	  <?vsp
              	      }
                    }
                  ?>
                </table>
              </vm:if>
              <vm:if test="self.i_type = 3">
                    <table id="ldap" class="AB_grid" style="border-width: 0" cellspacing="0">
                  <thead class="sortHeader">
                    <tr>
                      <th>LDAP Property</th>
                      <th>Contact Property</th>
                      <th>Sample Data (based on first record)</th>
                    </tr>
                  </thead>
                  <tr>
                  </tr>
                  <?vsp
                      declare L, N, M integer;
                    declare data any;

                      self.i_Options := LDAP..contact_fields ();
                      for (N := 0; N < length (self.i_data); N := N + 2)
                      {
                        if (self.i_data [N] = 'entry')
                        {
              	        data := self.i_data [N+1];
                          if (isnull (self.i_lMaps)) {
                            for (M := 0; M < length (data); M := M + 2)
                            {
              	  ?>
              	  <tr>
              	    <td>
              		    <?V data[M] ?>
              		  </td>
              		  <td nowrap="1">
              		    <?vsp
              		      self.render_select (data[M]);
              		    ?>
              		  </td>
              		  <td>
              		    <?V substring (case when isstring (data[M+1]) then data[M+1] else data[M+1][0] end, 1, 50) ?>
              		  </td>
                  </tr>
              	  <?vsp
                        }
                        goto _end;
                          } else {
                            for (M := 0; M < length (self.i_lMaps); M := M + 2)
                            {
                    ?>
                    <tr>
                      <td>
                        <?V self.i_lMaps[M] ?>
                      </td>
                      <td nowrap="1">
                        <?vsp
                          self.render_select (self.i_lMaps[M]);
                        ?>
                      </td>
                      <td>
                        <?vsp
                          for (L := 0; L < length (data); L := L + 2)
                          {
                            if (data[L] = self.i_lMaps[M])
                              http (substring (case when isstring (data[L+1]) then data[L+1] else data[L+1][0] end, 1, 50));
                          }
                        ?>
                      </td>
                    </tr>
                    <?vsp
                            }
                            goto _end;
                          }
              	      }
                    }
                  _end:;
                  ?>
                </table>
              </vm:if>
	            </div>
              <div class="new-form-mapping2">
                <v:button action="simple" value="Default" xhtml_class="form-button" xhtml_style="margin: 5px 0px 0px 0px;">
                  <v:on-post>
                    <![CDATA[
                      if (self.i_type = 2) {
                        declare N, M integer;
                        declare tmp, data any;

                        tmp := vector (
                          'Title',                'P_TITLE',
                          'First Name',           'P_FIRST_NAME',
                          'Middle Name',          'P_MIDDLE_NAME',
                          'Last Name',            'P_LAST_NAME',
                          'Gender',               'P_GENDER',
                          'Birthday',             'P_BIRTHDAY',
                          'Company',              'P_B_ORGANIZATION',
                          'Job Title',            'P_B_JOB',
                          'Business Street',      'P_B_ADDRESS1',
                          'Business Street 2',    'P_B_ADDRESS2',
                          'Business City',        'P_B_CITY',
                          'Business State',       'P_B_STATE',
                          'Business Postal Code', 'P_B_CODE',
                          'Business Country',     'P_B_COUNTRY',
                          'Business Phone',       'P_B_PHONE',
                          'Business Fax',         'P_B_FAX',
                          'Home Street',          'P_H_ADDRESS1',
                          'Home Street 2',        'P_H_ADDRESS2',
                          'Home City',            'P_H_CITY',
                          'Home State',           'P_H_STATE',
                          'Home Postal Code',     'P_H_CODE',
                          'Home Country',         'P_H_COUNTRY',
                          'Home Phone',           'P_H_PHONE',
                          'Home Fax',             'P_H_FAX',
                          'E-mail Address',       'P_MAIL',
                          'E-mail 2 Address',     'P_H_MAIL',
                          'E-mail 3 Address',     'P_B_MAIL');

                          if (length (self.i_data))
                          {
                          self.i_maps := vector ();
                          data := split_and_decode (self.i_data [N], 0, '\0\0,');
                            for (N := 0; N < length (data); N := N + 1)
                            {
                            for (M := 0; M < length (tmp); M := M + 2)
                                if (trim (data[N], '"') = tmp[M])
                                {
                                self.i_maps := vector_concat (self.i_maps, vector (cast (N as varchar), tmp[M+1]));
                                goto _next;
                              }
                          _next:;
                          }
                        }
                      }

                      if (self.i_type = 3)
                        if (isnull (self.i_lMaps)) {
                          self.i_maps := vector (
                          'uid',  'P_NAME',
                          'cn',   'P_FULL_NAME',
                          'mail', 'P_MAIL');
                        } else {
                          self.i_maps := self.i_lMaps;
                        }

                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button action="simple" value="Reset" xhtml_class="form-button" xhtml_style="margin: 5px 5px 0px 0px;">
                  <v:on-post>
                    <![CDATA[
                      self.i_maps := null;
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
              </div>
	            <div class="new-form-footer">
	              <v:button action="simple" value="Back" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
                      self.abStep := AB.WA.pop (self.abSteps);
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
                <v:button action="simple" value="Next" xhtml_class="form-button">
                  <v:on-post>
                    <![CDATA[
                      declare N integer;
                      declare params any;

                      params := e.ve_params;
                      self.i_maps := vector ();
                      for (N := 0; N < length (params); N := N + 2)
                        if (params[N] like 'sel_%' and params[N+1] <> 'skip')
                          self.i_maps := vector_concat (self.i_maps, vector (substring (params[N], 5, length (params[N])), params[N+1]));

                      self.abStep := '6';
                      AB.WA.push (self.abSteps, '5');
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button action="simple" name="i5_cancel" value="Cancel" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    self.abAction := 'browse';
                      self.resetImport ();
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
	            </div>
              <script>
                <![CDATA[
                  coloriseTable('ldap');
                ]]>
              </script>
	          </v:template>

            <v:template type="simple" enabled="-- case when (self.abStep = '6') then 1 else 0 end">
	            <div class="new-form-header">
	              <v:label format="%s" value="Import: Options"/>
	            </div>

	            <div class="new-form-body">
	              <table id="progressHide" cellspacing="0">
	                <tr>
	                  <th>
                      <v:label for="i_tags" value="Tags (comma-separated)" />
	                  </th>
	                  <td>
                      <v:text name="i_tags" value="--self.v_tag" xhtml_class="textbox" xhtml_size="60" />
	                  </td>
	                </tr>
                    <?vsp self.myTags ('i_tags'); ?>
                  <tr>
                    <th valign="top">
                      Validation Fields
                    </th>
                    <td>
                        <div style="height: 400px; overflow: auto;">
                        <table cellspacing="0" style="background-color: #fff;">
                          <?vsp
                            declare N integer;
                            declare data, fields any;

                            data := coalesce ((select deserialize (LV_FIELDS) from LDAP..LDAP_VALIDATION where LV_USER_ID = self.account_id), vector());
                            fields := LDAP..contact_fields ();
                              for (N := 0; N < length (fields); N := N + 2)
                              {
                      	  ?>
                      	  <tr>
                      	    <td width="1%">
                      	      <?vsp
                                declare S varchar;
                                S := '';
                                if (get_keyword(fields[N], data, '') <> '')
                                  S := 'checked="checked"';
                                http (sprintf ('<input type="checkbox" %s name="cb_item" value="%s"', S, fields[N]));
                              ?>
                      		  </td>
                      		  <td >
                      		    <?V fields[N+1] ?>
                      		  </td>
                          </tr>
                      	  <?vsp
                            }
                          ?>
                        </table>
                      </div>
                    </td>
                  </tr>
	              </table>
	            </div>

	            <div class="new-form-footer">
	              <v:button action="simple" value="Back" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
                      self.abStep := AB.WA.pop (self.abSteps);
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
	              <v:button action="simple" value="Import" xhtml_class="form-button">
			            <v:on-post>
			              <![CDATA[
                      declare N integer;
                      declare tmp, params any;

                        declare exit handler for SQLSTATE '*'
                        {
                          if ((__SQL_STATE = 'TEST') or (__SQL_STATE like 'AB%')) 
                          {
                          self.vc_error_message := AB.WA.test_clear (__SQL_MESSAGE);
                          self.vc_is_valid := 0;
                          return;
                        }
                        resignal;
                      };

                      -- test tags value
                      self.v_tags := trim (self.i_tags.ufl_value);
                      AB.WA.test (self.v_tags, vector ('name', 'Tags', 'class', 'tags'));
                      tmp := AB.WA.tags2vector (self.v_tags);
                      tmp := AB.WA.vector_unique (tmp);
                      self.v_tags := AB.WA.vector2tags (tmp);

                      params := e.ve_params;
                      self.i_validation := vector ();
                        for (N := 0; N < length (params); N := N + 4)
                        {
                        if (params[N] = 'cb_item')
                          self.i_validation := vector_concat (self.i_validation, vector (params[N+1]));
                      }

			                -- vCard
                      if (self.i_type = 0)
                          AB.WA.import_vcard (self.domain_id, self.i_data, vector ('tags', self.v_tags), self.i_validation);

			                -- FOAF
                      if (self.i_type = 1)
                          AB.WA.import_foaf (self.domain_id, self.i_data, self.v_tags, self.i_validation, 2, self.i_iri, self.i_contentItems, self.i_contentDepth, self.i_contentLimit, self.i_contentFollow);

			                -- CSV
                      if (self.i_type = 2)
                        AB.WA.import_csv (self.domain_id, self.i_data, self.v_tags, self.i_maps, self.i_validation);

			                -- LDAP
                      if (self.i_type = 3)
                        AB.WA.import_ldap (self.domain_id, self.i_data, self.v_tags, self.i_maps, self.i_validation);

	                    self.abAction := 'browse';
                      self.resetImport ();
                      self.vc_data_bind(e);
			               ]]>
			             </v:on-post>
			          </v:button>
                <v:button action="simple" name="i6_cancel" value="Cancel" xhtml_class="form-button">
	                <v:on-post>
	                  <![CDATA[
	                    self.abAction := 'browse';
                      self.resetImport ();
                      self.vc_data_bind(e);
	                  ]]>
	                </v:on-post>
	              </v:button>
	            </div>
	          </v:template>
          </v:template>

          <v:template type="simple" enabled="--case when (self.abAction = 'export') then 1 else 0 end">

            <div class="new-form-header">
              <v:label format="%s" value="-- case when (length (self.abSelected)) then 'Export selected contacts' else 'Export all contacts' end" />
            </div>

            <div class="new-form-body">
              <table cellspacing="0">
                <tr>
                  <th rowspan="3" valign="center">
                    <v:label for="e_format" value="Content type" />
                  </th>
                  <td>
                    <input type="radio" name="e_format" id="e_format_0" value="vCard" checked="checked" onclick="changeExportName('e_file', ['.foaf', '.csv'], '.vcf');" /><xsl:call-template name="nbsp" /><label for="e_format_0">vCard</label>
                  </td>
                </tr>
                <tr>
                  <td>
                    <input type="radio" name="e_format" id="e_format_1" value="FOAF" onclick="changeExportName('e_file', ['.vcf', '.csv'], '.foaf');" /><xsl:call-template name="nbsp" /><label for="e_format_1">FOAF</label>
                  </td>
                </tr>
                <tr>
                  <td>
                    <input type="radio" name="e_format" id="e_format_2" value="csv" onclick="changeExportName('e_file', ['.foaf', '.vcf'], '.csv');" /><xsl:call-template name="nbsp" /><label for="e_format_2">CSV</label>
                  </td>
                </tr>
                <tr>
                  <th>
                    <v:label for="e_file" value="File name"/>
                  </th>
                  <td>
                    <v:text name="e_file" value="--'contacts.vcf'" xhtml_class="textbox" xhtml_size="40" />
                  </td>
                </tr>
              </table>
            </div>

            <div class="new-form-footer">
              <v:button action="simple" value="Export" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                      declare params, entries any;

                    params := e.ve_params;

                    http_rewrite ();
                    http_request_status ('HTTP/1.1 200 OK');
                      http_header (sprintf ('Content-Type: application/x-download\r\nContent-Disposition: inline; filename="%s"\r\n', self.e_file.ufl_value));

                      entries := case when length (self.abSelected) then self.abSelected else null end;
                      if (get_keyword ('e_format', params) = 'vCard')
                      {
                        http (AB.WA.export_vcard (self.domain_id, entries));
                      }
                      else if (get_keyword ('e_format', params) = 'FOAF')
                      {
                        http (AB.WA.export_foaf (self.domain_id, entries));
                      }
                      else if (get_keyword ('e_format', params) = 'csv')
                      {
                      http (AB.WA.export_csv_head ());
                        http (AB.WA.export_csv (self.domain_id, entries));
                    }
                    http_flush ();

                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
              <v:button action="simple" name="e_cancel" value="Cancel" xhtml_class="form-button">
                <v:on-post>
                  <![CDATA[
                    self.abAction := 'browse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
            </div>

          </v:template>
          </div>
        </div>
      </vm:if>

      <vm:if test="self.abAction = 'settings'">
        <table id="MTB">
          <tr>
            <td id="LC">
              <div class="lc lc_close">
                <v:button action="simple" style="url" value="Settings" xhtml_class="gems2">
                <v:on-post>
                  <![CDATA[
                    self.abSubAction := '';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
                <v:button action="simple" style="url" value="Categories" xhtml_class="gems2">
                <v:on-post>
                  <![CDATA[
                      self.abSubAction := 'categoryBrowse';
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button action="simple" style="url" value="Publications" xhtml_class="gems2">
                  <v:on-post>
                    <![CDATA[
                      self.abSubAction := 'publishBrowse';
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button action="simple" style="url" value="Subscriptions" xhtml_class="gems2">
                  <v:on-post>
                    <![CDATA[
                      self.abSubAction := 'subscribeBrowse';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
              <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
                <v:button action="simple" style="url" value="Back" xhtml_class="gems2">
                <v:on-post>
                  <![CDATA[
                    self.abAction := 'browse';
                    self.abSubAction := '';
                    self.vc_data_bind(e);
                  ]]>
                </v:on-post>
              </v:button>
              </div>
            </td>
            <td id="RC">
                <div class="new-form-header">
                <?vsp
                  declare S, T varchar;

                  S := 'Preferences: ';
                  T := '';
                  if (self.abSubAction = '')
                  {
                    T := 'Settings';
                  }
                  else if (self.abSubAction = 'categoryBrowse')
                  {
                    T := 'Categories';
                  }
                  else if (self.abSubAction = 'categoryCreate')
                  {
                    T := 'Categories/Create';
                  }
                  else if (self.abSubAction = 'categoryUpdate')
                  {
                    T := 'Categories/Update';
                  }
                  else if (self.abSubAction = 'publishBrowse')
                  {
                    T := 'Publications';
                  }
                  else if (self.abSubAction = 'publishCreate')
                  {
                    T := 'Publications/Create';
                  }
                  else if (self.abSubAction = 'publishUpdate')
                  {
                    T := 'Publications/Update';
                  }
                  else if (self.abSubAction = 'subscribeBrowse')
                  {
                    T := 'Subscriptions';
                  }
                  else if (self.abSubAction = 'subscribeCreate')
                  {
                    T := 'Subscriptions/Create';
                  }
                  else if (self.abSubAction = 'subscribeUpdate')
                  {
                    T := 'Subscriptions/Update';
                  }
                  http (S || T);
                ?>
      </div>
              <vm:if test="self.abSubAction =''">
                <div id="s" class="c1">
                  <div class="tabs">
                    &nbsp;<vm:tabCaption tab="s" tabsCount="2" tabNo="0" caption="Main" />
                    &nbsp;<vm:tabCaption tab="s" tabsCount="2" tabNo="1" caption="Discussion" />
                  </div>
                  <div class="contents">
                    <div id="s_content_0" class="tabContent">
                      <table class="form-body" cellspacing="0">
                  <tr>
                    <th width="30%">
                      <v:label for="f_chars" value="Contact name display"/>
                    </th>
                    <td>
                      <?vsp
                        declare S varchar;

                        S := '';
                        if (cast(get_keyword('chars', self.settings, '0') as integer) = 0)
                          S := 'checked="checked"';
                        http(sprintf('<input type="radio" name="r_chars" id="r_chars_0" value="0" %s />', S));
                      ?>
                      <xsl:call-template name="nbsp"/><vm:label for="r_chars_0" value="--'show everything'" />
                    </td>
                  </tr>
                  <tr>
                    <th />
                    <td>
                      <?vsp
                        declare S varchar;

                        S := '';
                        if (cast(get_keyword('chars', self.settings, '0') as integer) <> 0)
                          S := 'checked="checked"';
                        http(sprintf('<input type="radio" name="r_chars" id="r_chars_1" value="1" %s />', S));
                      ?>
                      <xsl:call-template name="nbsp"/><vm:label for="r_chars_1" value="--'show no more than'" /><xsl:call-template name="nbsp"/>
                      <v:text name="f_chars" null-value="--''" value="--get_keyword('chars', self.settings, '60')" xhtml_size="3"/>
                      <xsl:call-template name="nbsp"/><vm:label for="r_chars_1" value="--'characters'" /><xsl:call-template name="nbsp"/>
                    </td>
                  </tr>
                  <tr>
                    <th width="30%"/>
                    <td>
                      <v:check-box name="f_tbLabels" xhtml_id="f_tbLabels" is-boolean="1" true-value="1" false-value="0" value="--cast(get_keyword('tbLabels', self.settings, '1') as integer)" />
                      <vm:label for="f_tbLabels" value="Show toolbar labels"/>
                    </td>
                  </tr>
                  <tr>
                    <th>
                      <v:label for="f_rows" value="Rows per page"/>
                    </th>
                    <td>
                      <v:text name="f_rows" value="--get_keyword('rows', self.settings, '10')" xhtml_size="3"/>
                    </td>
                  </tr>
                  <tr>
                    <th>
                      Atom File Version
                    </th>
                    <td>
                      <v:select-list name="f_atomVersion">
                        <v:item value="0.3" name="0.3"/>
                        <v:item value="1.0" name="1.0"/>
                        <v:before-data-bind>
                          <![CDATA[
                            control.ufl_value := get_keyword('atomVersion', self.settings, '1.0');
                          ]]>
                        </v:before-data-bind>
                      </v:select-list>
                    </td>
                  </tr>
                </table>
                </div>
                    <div id="s_content_1" class="tabContent" style="display: none;">
                      <table class="form-body" cellspacing="0">
                        <v:template type="simple" enabled="--either (equ (AB.WA.discussion_check (), 1), 0, 1)">
                          <tr>
                            <td class="error_text" colspan="2">
                              <b>The Discussion feature is disabled. You need to install the ODS Discussion package in order to use it.</b>
                            </td>
                          </tr>
                        </v:template>
                        <tr>
                          <th width="30%">&nbsp;</th>
                          <td>
                            <?vsp
                              declare S, T varchar;

                              S := '';
                    				  if (not AB.WA.discussion_check ())
                    				    S := 'disabled="disabled"';
                              T := '';
                    				  if (cast(get_keyword ('conv', self.settings, '0') as integer) = 1)
                    				    T := 'checked';
                              http (sprintf ('<input type="checkbox" name="f_conv" value="1" %s %s />', T, S));
                            ?>
                    				<vm:label for="f_conv" value="Enable discussions on this instance" />
                          </td>
                        </tr>
                        <tr>
                          <th width="30%">&nbsp;</th>
                          <td>
                            <?vsp
                              declare S, T varchar;

                              S := '';
                    				  if (not AB.WA.discussion_check ())
                    				    S := 'disabled="disabled"';
                              T := '';
                    				  if (cast(get_keyword ('conv_init', self.settings, '0') as integer) = 1)
                    				    T := 'checked';
                              http (sprintf ('<input type="checkbox" name="f_conv_init" value="1" %s %s />', T, S));
                            ?>
                    				<vm:label for="f_conv_init" value="Initialize the news group with existing posts" />
                          </td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="new-form-footer">
                  <v:button action="simple" value="Save" xhtml_class="form-button">
                    <v:on-post>
                      <![CDATA[
                        declare rows, chars any;
                        declare conv, f_conv, f_conv_init, params any;

                        params := self.vc_page.vc_event.ve_params;

                        declare exit handler for SQLSTATE '*'
                        {
                          if (__SQL_STATE = 'TEST')
                          {
                            self.vc_error_message := AB.WA.test_clear(__SQL_MESSAGE);
                            self.vc_is_valid := 0;
                            return;
                          }
                          resignal;
                        };

                        rows := trim(self.f_rows.ufl_value);
                        chars := trim(self.f_chars.ufl_value);
                        if (get_keyword ('r_chars', self.vc_page.vc_event.ve_params, '-1') = '0')
                          chars := '0';

                        AB.WA.test (rows, vector('name', 'Rows per page', 'class', 'integer', 'type', 'integer', 'minValue', 5, 'maxValue', 1000));
                        AB.WA.test (chars, vector('name', 'Max name length', 'class', 'integer', 'type', 'integer', 'minValue', 0, 'maxValue', 1000));

                        conv := cast (get_keyword ('conv', self.settings, '0') as integer);
                        f_conv := cast (get_keyword ('f_conv', params, '0') as integer);
                        f_conv_init := cast (get_keyword ('f_conv_init', params, '0') as integer);

                        self.settings := AB.WA.set_keyword ('chars', self.settings, cast(cast(chars as integer) as varchar));
                        self.settings := AB.WA.set_keyword ('rows', self.settings, cast(cast(rows as integer) as varchar));
                        self.settings := AB.WA.set_keyword ('tbLabels', self.settings, self.f_tbLabels.ufl_selected);
                        self.settings := AB.WA.set_keyword ('atomVersion', self.settings, self.f_atomVersion.ufl_value);
                        self.settings := AB.WA.set_keyword ('conv', self.settings, f_conv);
                        self.settings := AB.WA.set_keyword ('conv_init', self.settings, f_conv_init);

                        insert replacing AB.WA.SETTINGS(S_DOMAIN_ID, S_DATA, S_ACCOUNT_ID) values(self.domain_id, serialize(self.settings), self.account_id);
                        commit work;

                        AB.WA.domain_gems_create(self.domain_id, self.account_id);

                    		if (AB.WA.discussion_check ())
                    		{
              					  AB.WA.nntp_update (self.domain_id, null, null, conv, f_conv);
                   				if (f_conv and f_conv_init)
              					    AB.WA.nntp_fill (self.domain_id);
              					}

                        self.vc_data_bind(e);
                      ]]>
                    </v:on-post>
                  </v:button>
                  <v:button action="simple" value="Clear" xhtml_class="form-button">
                    <v:on-post>
                      <![CDATA[
                        delete from AB.WA.SETTINGS where S_ACCOUNT_ID = self.account_id;
                        AB.WA.nntp_update (self.domain_id, null, null, 1, 0);

                        self.vc_data_bind(e);
                      ]]>
                    </v:on-post>
                  </v:button>
                </div>
              </vm:if>

              <vm:if test="self.abSubAction = 'categoryBrowse'">
                <v:button value="--'New Category'" action="simple" xhtml_class="button">
                  <v:on-post>
                    <![CDATA[
                      self.abSubAction := 'categoryCreate';
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button value="Delete" action="simple" xhtml_onclick="--'javascript: return confirmAction(\'Are you sure that you want to delete this selected items?\', document.F1, \'cb_\', \'No items were selected for deletion.\');'" xhtml_class="button">
                  <v:on-post>
                    <![CDATA[
                      declare N integer;

                      for (N := 0; N < length(e.ve_params); N := N + 4)
                        if (e.ve_params[N] = 'cb_item')
                          delete from AB.WA.CATEGORIES where C_ID = cast (e.ve_params[N+1] as integer);

                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:data-set name="ds_categories" sql="select * from AB.WA.CATEGORIES where C_DOMAIN_ID = :p0 order by C_NAME" nrows="0" scrollable="1">
                  <v:param name="p0" value="--self.domain_id" />

                  <v:template name="ds_categories_header" type="simple" name-to-remove="table" set-to-remove="bottom">
                    <table id="categoriesTable" style="width: 100%; background-color: #FFF;" cellspacing="0">
                      <thead class="sortHeader">
                        <tr>
                          <th class="checkbox" width="1%">
                            <input type="checkbox" name="cb_all" value="Select All" onclick="selectAllCheckboxes(this, 'cb_item')" />
                          </th>
                          <th style="text-align: left;">Name</th>
                          <th style="text-align: left;" width="5%">Action</th>
                        </tr>
                      </thead>
                    </table>
                  </v:template>
                  <v:template name="ds_categories_repeat" type="repeat">

                    <v:template type="if-not-exists" name-to-remove="table" set-to-remove="both">
                      <table>
                        <tr align="center">
                          <td colspan="3">No categories</td>
                        </tr>
                      </table>
                    </v:template>

                    <v:template name="ds_categories_browse" type="browse" name-to-remove="table" set-to-remove="both">
                      <table>
                        <tr>
                          <td align="center" valign="top">
                            <input type="checkbox" name="cb_item" value="<?V (control as vspx_row_template).te_column_value('C_ID') ?>" onclick="selectCheck(this, 'cb_item')" />
                          </td>
                          <td nowrap="nowrap">
                            <v:label value="--(control.vc_parent as vspx_row_template).te_column_value('C_NAME')" />
                          </td>
                          <td nowrap="nowrap">
                            <v:button value="Edit" action="simple" xhtml_class="button">
                              <v:on-post>
                                <![CDATA[
                                  self.v_id := (control.vc_parent as vspx_row_template).te_column_value('C_ID');
                                  self.abSubAction := 'categoryUpdate';
                                  self.vc_data_bind(e);
                                ]]>
                              </v:on-post>
                            </v:button>
                          </td>
                        </tr>
                      </table>
                    </v:template>

                  </v:template>

                  <v:template type="simple" name-to-remove="table" set-to-remove="top">
                    <table>
                    </table>
                  </v:template>

                </v:data-set>
                <script type="text/javascript">
                  <![CDATA[
                    coloriseTable('categoriesTable');
                  ]]>
                </script>
              </vm:if>
              <vm:if test="self.abSubAction in ('categoryCreate', 'categoryUpdate')">
                <v:before-data-bind>
                  <![CDATA[
                    declare params any;
                    params := self.vc_page.vc_event.ve_params;

                    if (isnull (get_keyword ('su_name', params)))
                    {
                      declare exit handler for not found goto _end;

                      if (self.abSubAction = 'categoryUpdate')
                      {
                        declare tmp any;

                        select C_NAME
                          into self.v_name
                          from AB.WA.CATEGORIES
                         where C_ID = self.v_id;

                         return;
                      }
                    _end:;

                      self.v_name := '';
                    }
                  ]]>
                </v:before-data-bind>
                <div class="new-form-body">
                  <table class="form-body" cellspacing="0">
                  <tr>
                    <th width="30%">
                      Name
                    </th>
                    <td>
                      <v:text name="c_name" value="--self.v_name" xhtml_size="60" />
                    </td>
                  </tr>
                </table>
                </div>
                <div class="new-form-footer">
                  <v:button action="simple" value="--case when self.abSubAction = 'categoryCreate' then 'Create' else 'Update' end" name="s1u_save" xhtml_class="form-button">
                    <v:on-post>
                      <![CDATA[
                        declare exit handler for SQLSTATE '*'
                        {
                          if (__SQL_STATE = 'TEST')
                          {
                            self.vc_error_message := AB.WA.test_clear(__SQL_MESSAGE);
                            self.vc_is_valid := 0;
                            return;
                          }
                          if (__SQL_STATE = '23000')
                          {
                            rollback work;
                            self.vc_error_message := 'A category with same name already exists, please specify unique category name.';
                            self.vc_is_valid := 0;
                            return;
                          }
                          resignal;
                        };

                        self.v_name := trim (self.c_name.ufl_value);
                        AB.WA.test (self.v_name, vector('name', 'Category Name', 'class', 'varchar', 'minLength', 1, 'maxLength', 50));

                        if (self.abSubAction = 'categoryCreate')
                        {
                          self.v_id := sequence_next ('AB.WA.category_id');
                          insert into AB.WA.CATEGORIES (C_ID, C_DOMAIN_ID, C_NAME)
                            values (self.v_id, self.domain_id, self.v_name);
                        } else {
                          update AB.WA.CATEGORIES
                             set C_NAME = self.v_name
                           where C_ID = self.v_id;
                        }

                        self.abSubAction := 'categoryBrowse';
                        self.vc_data_bind(e);
                      ]]>
                    </v:on-post>
                  </v:button>
                  <v:button action="simple" value="Cancel" name="s1u_cancel" xhtml_class="form-button">
                    <v:on-post>
                      <![CDATA[
                        self.abSubAction := 'categoryBrowse';
                        self.vc_data_bind(e);
                      ]]>
                    </v:on-post>
                  </v:button>
                </div>
              </vm:if>

              <vm:if test="self.abSubAction in ('publishBrowse', 'subscribeBrowse')">
                <v:button value="--'New'" action="simple" xhtml_class="button">
                  <v:after-data-bind>
                    <![CDATA[
                      if (self.abSubAction = 'publishBrowse')
                      {
                        control.ufl_value := 'New Publication';
                      } else {
                        control.ufl_value := 'New Subscription';
                      }
                    ]]>
                  </v:after-data-bind>
                  <v:on-post>
                    <![CDATA[
                      if (self.abSubAction = 'publishBrowse')
                      {
                        self.abSubAction := 'publishCreate';
                      } else {
                        self.abSubAction := 'subscribeCreate';
                      }
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:button value="Delete" action="simple" xhtml_onclick="--'javascript: return confirmAction(\'Are you sure that you want to delete the selected item(s)?\', document.F1, \'cb_item\', \'No items were selected for deletion.\');'" xhtml_class="button">
                  <v:on-post>
                    <![CDATA[
                      declare N integer;

                      for (N := 0; N < length(e.ve_params); N := N + 4)
                        if (e.ve_params[N] = 'cb_item')
                          delete from AB.WA.EXCHANGE where EX_ID = cast (e.ve_params[N+1] as integer);

                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
                <v:data-source name="dsrc_exchanges" expression-type="sql" nrows="0" initial-offset="0">
                  <v:before-data-bind>
                    <![CDATA[
                      control.ds_sql := sprintf ('select * from AB.WA.EXCHANGE where EX_DOMAIN_ID = %d and EX_TYPE = %d order by EX_NAME', self.domain_id, case when self.abSubAction = 'publishBrowse' then 0 else 1 end);
                    ]]>
                  </v:before-data-bind>
                </v:data-source>

                <v:data-set name="ds_exchanges" data-source="self.dsrc_exchanges" scrollable="1">
                  <v:template name="ds_exchanges_header" type="simple" name-to-remove="table" set-to-remove="bottom">
                    <table id="preferences" style="width: 100%; background-color: #FFF;" cellspacing="0">
                      <thead class="sortHeader">
                        <tr>
                          <th class="checkbox" width="1%">
                            <input type="checkbox" name="cb_all" value="Select All" onclick="selectAllCheckboxes(this, 'cb_item')" />
                          </th>
                          <th style="text-align: left;">Name</th>
                          <th style="text-align: left;" width="5%" nowrap="nowrap">Executed On</th>
                          <th style="text-align: left;" width="5%" nowrap="nowrap">Status</th>
                          <th style="text-align: left;" width="5%" nowrap="nowrap">Action</th>
                        </tr>
                      </thead>
                    </table>
                  </v:template>
                  <v:template name="ds_exchanges_repeat" type="repeat">

                    <v:template type="if-not-exists" name-to-remove="table" set-to-remove="both">
                      <table>
                      </table>
                    </v:template>

                    <v:template name="ds_exchanges_browse" type="browse" name-to-remove="table" set-to-remove="both">
                      <table>
                        <tr>
                          <td align="center" valign="top">
                            <input type="checkbox" name="cb_item" value="<?V (control as vspx_row_template).te_column_value('EX_ID') ?>" onclick="selectCheck(this, 'cb_item')" />
                          </td>
                          <td nowrap="nowrap">
                            <v:label value="--(control.vc_parent as vspx_row_template).te_column_value('EX_NAME')" />
                          </td>
                          <td nowrap="nowrap">
                            <v:label value="--AB.WA.dt_format ((control.vc_parent as vspx_row_template).te_column_value('EX_EXEC_TIME'), 'Y-M-D H:N')" />
                          </td>
                          <td nowrap="nowrap">
                      		  <?vsp
                      		    if ((control as vspx_row_template).te_column_value('EX_EXEC_LOG') is not null)
                      		    {
                      		      http (sprintf ('<a href="#" onclick="javascript: window.open (\'message.vspx?msg=%U\', \'calendar_message\', \'top=100, left=100, scrollbars=yes, resize=yes, menubar=no, height=420, width=500\');"><img src="/ods/images/icons/stop_16.png" border="0"/></a>', (control as vspx_row_template).te_column_value('EX_EXEC_LOG')));
                      		    }
                      		    else
                      		    {
                      		      http ('OK');
                      		    }
                      		  ?>
                          </td>
                          <td nowrap="nowrap">
                            <v:button value="Edit" action="simple" xhtml_class="button">
                              <v:on-post>
                                <![CDATA[
                                  self.ve_id := (control.vc_parent as vspx_row_template).te_column_value('EX_ID');
                                  if (self.abSubAction = 'publishBrowse')
                                  {
                                    self.abSubAction := 'publishUpdate';
                                  } else {
                                    self.abSubAction := 'subscribeUpdate';
                                  }
                                  self.vc_data_bind(e);
                                ]]>
                              </v:on-post>
                            </v:button>
                            <v:button value="Exec" action="simple" xhtml_class="button">
                              <v:on-post>
                                <![CDATA[
                                  declare exit handler for SQLSTATE '*'
                                  {
                                    if (__SQL_STATE like 'AB%')
                                    {
                                      self.vc_error_message := AB.WA.test_clear(__SQL_MESSAGE);
                                      self.vc_is_valid := 0;
                                      return;
                                    }
                                    resignal;
                                  };
                                  self.ve_id := (control.vc_parent as vspx_row_template).te_column_value('EX_ID');
                                  AB.WA.exchange_exec (self.ve_id);
                                  self.vc_data_bind(e);
                                ]]>
                              </v:on-post>
                            </v:button>
                          </td>
                        </tr>
                      </table>
                    </v:template>

                  </v:template>

                  <v:template type="simple" name-to-remove="table" set-to-remove="top">
                    <table>
                    </table>
                  </v:template>

                </v:data-set>
              </vm:if>

              <vm:if test="self.abSubAction in ('publishCreate', 'publishUpdate', 'subscribeCreate', 'subscribeUpdate')">
                <v:before-data-bind>
                  <![CDATA[
                    declare params any;
                    params := self.vc_page.vc_event.ve_params;

                    if (isnull (get_keyword ('exc_name', params)))
                    {
                      declare exit handler for not found goto _end2;

                      if (self.abSubAction in  ('publishUpdate', 'subscribeUpdate'))
                      {
                        select EX_TYPE,
                               EX_NAME,
                               EX_UPDATE_TYPE,
                               EX_UPDATE_PERIOD,
                               EX_UPDATE_FREQ,
                               deserialize (EX_OPTIONS)
                          into self.ve_type,
                               self.ve_name,
                               self.ve_update_type,
                               self.ve_update_period,
                               self.ve_update_freq,
                               self.ve_options
                          from AB.WA.EXCHANGE
                         where EX_ID = self.ve_id;

                         return;
                      }
                    _end2:;

                      self.ve_type := case when (self.abSubAction = 'publishCreate') then 0 else 1 end;
                      self.ve_id := null;
                      self.ve_name := '';
                      self.ve_update_type := case when (self.abSubAction = 'publishCreate') then 1 else 2 end;
                      self.ve_update_period := case when (self.abSubAction = 'publishCreate') then null else 'hourly' end;
                      self.ve_update_freq := case when (self.abSubAction = 'publishCreate') then null else 1 end;
                      self.ve_options := vector ();
                    }
                  ]]>
                </v:before-data-bind>
                <div class="new-form-body">
                  <table cellspacing="0">
                    <tr>
                      <th width="30%">
                        <v:label for="exc_name" value="Name" />
                      </th>
                      <td>
                        <v:text name="exc_name" null-value="--''" value="--self.ve_name" xhtml_size="60" />
                      </td>
                    </tr>
                    <tr>
                      <th rowspan="<?V case when (self.abSubAction in ('publishCreate', 'publishUpdate')) then 3 else 2 end ?>" valign="top">
                        Refresh type
                      </th>
                      <td nowrap="nowarap">
                        <label>
                          <v:radio-button name="exc_update_type_0" group-name="exc_update_type" value="0">
                            <v:before-render>
                              <![CDATA[
                                control.ufl_selected := either (lte (self.ve_update_type, 0), 1, 0);
                              ]]>
                            </v:before-render>
                          </v:radio-button>
                          <b>manually</b>
                        </label>
                      </td>
                    </tr>
                    <vm:if test="self.abSubAction in ('publishCreate', 'publishUpdate')">
                      <tr>
                        <td nowrap="nowarap">
                          <label>
                            <v:radio-button name="exc_update_type_1" group-name="exc_update_type" value="1">
                              <v:before-render>
                                <![CDATA[
                                  control.ufl_selected := either (equ (self.ve_update_type, 1), 1, 0);
                                ]]>
                              </v:before-render>
                            </v:radio-button>
                            <b>after any entry is changed</b>
                          </label>
                        </td>
                      </tr>
                    </vm:if>
                    <tr>
                      <td nowrap="nowarap">
                        <label>
                          <v:radio-button name="exc_update_type_2" group-name="exc_update_type" value="2">
                            <v:before-render>
                              <![CDATA[
                                control.ufl_selected := either (equ (self.ve_update_type, 2), 1, 0);
                              ]]>
                            </v:before-render>
                          </v:radio-button>
                          <b>every</b>
                        </label>
                        <v:text name="exc_update_freq" value="--self.ve_update_freq" xhtml_size="2" />
                        <v:select-list name="exc_update_period">
                          <v:item value="hourly" name="hour(s)" />
                          <v:item value="dayly" name="day(s)" />
                          <v:before-data-bind>
                            <![CDATA[
                              control.ufl_value := self.ve_update_period;
                            ]]>
                          </v:before-data-bind>
                        </v:select-list>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2" class="new-section">
                        <?V case when (self.abSubAction in ('publishCreate', 'publishUpdate')) then 'Destination' else  'Source' end ?>
                      </td>
                    </tr>
                    <tr>
                      <th rowspan="2" valign="top">
                        <?V case when (self.abSubAction in ('publishCreate', 'publishUpdate')) then 'Destination' else  'Source' end ?> type
                      </th>
                      <td nowrap="nowarap">
                        <label>
                          <v:radio-button name="exc_options_type_1" group-name="exc_options_type" value="1" xhtml_onchange="javascript: destinationChange(this, {show: [\'exc_options_name_button\'], clear: [\'exc_options_name\']});">
                            <v:before-render>
                              <![CDATA[
                                control.ufl_selected := either (lte (get_keyword ('type', self.ve_options, 1), 1), 1, 0);
                              ]]>
                            </v:before-render>
                          </v:radio-button>
                          <b>WebDAV Path</b>
                        </label>
                      </td>
                    </tr>
                    <tr>
                      <td nowrap="nowarap">
                        <label>
                          <v:radio-button name="exc_options_type_2" group-name="exc_options_type" value="2" xhtml_onchange="javascript: destinationChange(this, {hide: [\'exc_options_name_button\'], clear: [\'exc_options_name\']});">
                            <v:before-render>
                              <![CDATA[
                                control.ufl_selected := either (equ (get_keyword ('type', self.ve_options, 1), 2), 1, 0);
                              ]]>
                            </v:before-render>
                          </v:radio-button>
                          <b>URL</b>
                        </label>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        WebDAV Path / URL
                      </th>
                      <td>
                        <v:text name="exc_options_name" xhtml_id="exc_options_name" value="--get_keyword ('name', self.ve_options)" xhtml_size="60" />
                        <v:button action="browse" value="Browse..." name="exc_options_name_button" xhtml_id="exc_options_name_button">
                          <v:after-data-bind>
                            <![CDATA[
                              control.vc_add_attribute ('onclick', 'javascript: davBrowse (''exc_options_name'');');
                              control.vc_add_attribute ('style', 'display: ' || case when get_keyword ('type', self.ve_options, 1) = 1 then '' else 'none' end);
                            ]]>
                          </v:after-data-bind>
                        </v:button>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        User
                      </th>
                      <td>
                        <v:text name="exc_options_user" value="--get_keyword ('user', self.ve_options)" />
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Password
                      </th>
                      <td>
                        <v:text name="exc_options_password" type="password"  value="--get_keyword ('password', self.ve_options)" />
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2" class="new-section">
                        Options
                      </td>
                    </tr>
                    <tr>
                      <th>
                        <v:label for="exc_tags_include" value="Include with tags (comma-separated)" />
                      </th>
                      <td>
                        <v:text name="exc_tags_include" value="--get_keyword ('tagsInclude', self.ve_options)" xhtml_class="textbox" xhtml_size="60" />
                        <input type="button" value="Clear" onclick="javascript: document.F1.elements['exc_tags_include'].value = ''" class="button" />
                      </td>
                    </tr>
                    <?vsp self.myTags ('exc_tags_include'); ?>
                    <tr>
                      <th>
                        <v:label for="exc_tags_exclude" value="Exclude with tags (comma-separated)" />
                      </th>
                      <td>
                        <v:text name="exc_tags_exclude" value="--get_keyword ('tagsExclude', self.ve_options)" xhtml_class="textbox" xhtml_size="60" />
                        <input type="button" value="Clear" onclick="javascript: document.F1.elements['exc_tags_exclude'].value = ''" class="button" />
                      </td>
                    </tr>
                    <?vsp self.myTags ('exc_tags_exclude'); ?>
                  </table>
                </div>
                <div class="new-form-footer">
                  <v:button action="simple" value="--case when self.abSubAction in ('publishCreate', 'subscribeCreate') then 'Create' else 'Update' end" name="exc_save" xhtml_class="form-button">
                    <v:on-post>
                      <![CDATA[
                        declare _type, _name, _user, _password, _tagsInclude, _tagsExclude any;
                        declare tmp, params any;

                        declare exit handler for SQLSTATE '*'
                        {
                          if (__SQL_STATE = 'TEST')
                          {
                            self.vc_error_message := AB.WA.test_clear(__SQL_MESSAGE);
                            self.vc_is_valid := 0;
                            return;
                          }
                          resignal;
                        };
                        params := self.vc_page.vc_event.ve_params;


                        self.ve_name := trim (self.exc_name.ufl_value);
                        self.ve_update_freq := null;
                        self.ve_update_period := null;
                        if (self.exc_update_type_0.ufl_selected)
                        {
                          self.ve_update_type := 0;
                        }
                        else if (self.exc_update_type_1.ufl_selected)
                        {
                          self.ve_update_type := 1;
                        }
                        else if (self.exc_update_type_2.ufl_selected)
                        {
                          self.ve_update_type := 2;
                          self.ve_update_freq := self.exc_update_freq.ufl_value;
                          self.ve_update_period := self.exc_update_period.ufl_value;
                        }
                        _type := 0;
                        if (self.exc_options_type_1.ufl_selected)
                        {
                          _type := 1;
                        }
                        else if (self.exc_options_type_2.ufl_selected)
                        {
                          _type := 2;
                        }
                        _name := trim (self.exc_options_name.ufl_value);
                        _user := trim (self.exc_options_user.ufl_value);
                        _password := self.exc_options_password.ufl_value;

                        tmp := trim (self.exc_tags_include.ufl_value);
                        AB.WA.test (tmp, vector ('name', 'Include Tags', 'class', 'tags'));
                        tmp := AB.WA.tags2vector (tmp);
                        tmp := AB.WA.vector_unique (tmp);
                        _tagsInclude := AB.WA.vector2tags (tmp);

                        tmp := trim (self.exc_tags_exclude.ufl_value);
                        AB.WA.test (tmp, vector ('name', 'Exclude Tags', 'class', 'tags'));
                        tmp := AB.WA.tags2vector (tmp);
                        tmp := AB.WA.vector_unique (tmp);
                        _tagsExclude := AB.WA.vector2tags (tmp);
                        self.ve_options := vector ('type', _type, 'name', _name, 'user', _user, 'password', _password, 'tagsInclude', _tagsInclude, 'tagsExclude', _tagsExclude);

                        AB.WA.test (self.ve_name, vector('name', 'Name', 'class', 'varchar', 'minLength', 1, 'maxLength', 255));
                        if (self.ve_update_type = 2)
                          AB.WA.test (self.ve_update_freq, vector ('name', 'Frequency', 'class', 'integer', 'minValue', 1, 'maxValue', 30));
                        AB.WA.test (_name, vector('name', 'Resource Name', 'class', 'varchar', 'minLength', 1, 'maxLength', 255));

                        self.ve_update_freq := cast (self.ve_update_freq as integer);
                        if (self.abSubAction in ('publishCreate', 'subscribeCreate'))
                        {
                          insert into AB.WA.EXCHANGE (EX_DOMAIN_ID, EX_TYPE, EX_NAME, EX_UPDATE_TYPE, EX_UPDATE_PERIOD, EX_UPDATE_FREQ, EX_OPTIONS)
                            values (self.domain_id, self.ve_type, self.ve_name, self.ve_update_type, self.ve_update_period, self.ve_update_freq, serialize (self.ve_options));
                        } else {
                          update AB.WA.EXCHANGE
                             set EX_NAME = self.ve_name,
                                 EX_UPDATE_TYPE = self.ve_update_type,
                                 EX_UPDATE_PERIOD = self.ve_update_period,
                                 EX_UPDATE_FREQ = self.ve_update_freq,
                                 EX_OPTIONS = serialize (self.ve_options)
                           where EX_ID = self.ve_id;
                        }

                        self.abSubAction := case when (self.abSubAction in ('publishCreate', 'publishUpdate')) then 'publishBrowse' else 'subscribeBrowse' end;
                        self.vc_data_bind(e);
                      ]]>
                    </v:on-post>
                  </v:button>
                  <v:button action="simple" value="Cancel" name="exc_cancel" xhtml_class="form-button">
                    <v:on-post>
                      <![CDATA[
                        self.abSubAction := case when (self.abSubAction in ('publishCreate', 'publishUpdate')) then 'publishBrowse' else 'subscribeBrowse' end;
                        self.vc_data_bind(e);
                      ]]>
                    </v:on-post>
                  </v:button>
                </div>
              </vm:if>
            </td>
          </tr>
        </table>
      </vm:if>
    </vm:pagebody>
  </vm:pagewrapper>
</v:page>
